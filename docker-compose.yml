
services:
  # WCMS 서버 (Flask)
  wcms-server:
    build:
      context: .
      dockerfile: Dockerfile.server
    container_name: wcms-server
    ports:
      - "5050:5050"
    environment:
      - WCMS_ENV=production
      - WCMS_SECRET_KEY=${WCMS_SECRET_KEY:-change-this-in-production}
      - WCMS_HOST=0.0.0.0
      - WCMS_PORT=5050
      - WCMS_DB_PATH=/app/db/wcms.sqlite3
      - WCMS_LOG_LEVEL=INFO
    volumes:
      - ./db:/app/db
      - ./logs:/app/logs
    networks:
      - wcms-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5050/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # Windows 11 테스트 클라이언트 (dockurr/windows)
  wcms-client-windows:
    image: dockurr/windows:latest
    container_name: wcms-test-win
    ports:
      - "8006:8006"  # Web VNC (noVNC)
      - "5900:5900"  # VNC
      - "3389:3389"  # RDP
    environment:
      - VERSION=win11
      # RAM 할당 (GB) - 시스템 메모리에 따라 조정
      - RAM_SIZE=${DOCKER_WIN_RAM:-8G}
      - CPU_CORES=${DOCKER_WIN_CPUS:-4}
      # 디스크 크기 (GB)
      - DISK_SIZE=64G
      # VNC 비밀번호 (선택)
      - VNC_PASSWORD=${VNC_PASSWORD:-wcms2026}
      # Windows 자동 로그인
      - USERNAME=Administrator
      - PASSWORD=${WIN_PASSWORD:-Wcms2026!}
    devices:
      - /dev/kvm
    cap_add:
      - NET_ADMIN
    privileged: true
    networks:
      - wcms-network
    extra_hosts:
      # 호스트 서버 접근 (Linux Docker)
      - "host.docker.internal:host-gateway"
    volumes:
      # Windows 영구 저장소 (재시작 후에도 유지)
      - wcms-windows-data:/storage
      # 로컬 ISO 파일 마운트 (공식 문서: /boot.iso)
      - ./iso/win11.iso:/boot.iso
      # 공유 폴더 (호스트 ↔ Windows 파일 공유)
      - ./shared:/shared
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8006 || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 5
      start_period: 600s  # 10분 부팅 시간

networks:
  wcms-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  wcms-windows-data:
    driver: local
