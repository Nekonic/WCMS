{% extends "base.html" %}
{% block title %}ν΄λΌμ΄μ–ΈνΈ λ²„μ „ κ΄€λ¦¬{% endblock %}
{% block content %}
<div class="page-container-lg">
    <h2 style="margin-bottom: 1.5em;">π“¦ ν΄λΌμ΄μ–ΈνΈ λ²„μ „ κ΄€λ¦¬</h2>

    <!-- λ²„μ „ λ“±λ΅ νΌ -->
    <div class="section-card">
        <h3 style="margin-top: 0; margin-bottom: 1em; font-size: 1.1em; color: #ddd;">μƒ λ²„μ „ λ“±λ΅</h3>
        <form id="versionForm">
            <div class="form-grid-3" style="margin-bottom: 1em;">
                <div>
                    <label class="form-label fw-600">λ²„μ „ *</label>
                    <input type="text" id="version" placeholder="0.7.0" required class="form-input" style="padding: 0.5em;">
                </div>
                <div>
                    <label class="form-label fw-600">λ‹¤μ΄λ΅λ“ URL *</label>
                    <input type="url" id="downloadUrl" placeholder="https://github.com/..." required class="form-input" style="padding: 0.5em;">
                </div>
                <div class="flex-end">
                    <button type="submit" class="btn btn-info" style="width: 100%; padding: 0.5em 1em;">λ“±λ΅</button>
                </div>
            </div>
            <div>
                <label class="form-label fw-600">λ³€κ²½μ‚¬ν•­</label>
                <textarea id="changelog" rows="2" placeholder="μλ™ λΉλ“ - v0.7.0 λ¦΄λ¦¬μ¤" class="form-input" style="resize: vertical; padding: 0.5em;"></textarea>
            </div>
        </form>
    </div>

    <!-- λ²„μ „ λ©λ΅ -->
    <div class="section-card">
        <h3 style="margin-top: 0; margin-bottom: 1em; font-size: 1.1em; color: #ddd;">λ“±λ΅λ λ²„μ „ λ©λ΅</h3>
        <div style="overflow-x: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>λ²„μ „</th>
                        <th>λ‹¤μ΄λ΅λ“ URL</th>
                        <th>λ³€κ²½μ‚¬ν•­</th>
                        <th>λ“±λ΅μΌμ‹</th>
                        <th>μ‘μ—…</th>
                    </tr>
                </thead>
                <tbody id="versionList">
                    <tr><td colspan="5" class="text-center-msg" style="color: #888;">λ΅λ”© μ¤‘...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function loadVersions() {
    fetch('/api/client/versions')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('versionList');
            if (data.status === 'success' && data.versions.length > 0) {
                tbody.innerHTML = data.versions.map((v, index) => `
                    <tr>
                        <td>
                            <strong>${v.version}</strong>
                            ${index === 0 ? '<span class="badge-latest">μµμ‹ </span>' : ''}
                        </td>
                        <td><a href="${v.download_url}" target="_blank" style="color: #60a5fa; text-decoration: none; max-width: 300px; display: inline-block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${v.download_url}</a></td>
                        <td class="text-muted-sm">${v.changelog || '-'}</td>
                        <td class="text-muted-sm">${new Date(v.released_at).toLocaleString('ko-KR')}</td>
                        <td>
                            <button onclick="deleteVersion(${v.id}, '${v.version}')" class="btn btn-danger" style="padding: 0.25em 0.75em; font-size: 0.875em;">μ‚­μ </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center-msg" style="color: #888;">λ“±λ΅λ λ²„μ „μ΄ μ—†μµλ‹λ‹¤</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('versionList').innerHTML = '<tr><td colspan="5" class="text-center-msg text-error">λ΅λ“ μ‹¤ν¨</td></tr>';
        });
}

document.getElementById('versionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const version = document.getElementById('version').value.trim();
    const downloadUrl = document.getElementById('downloadUrl').value.trim();
    const changelog = document.getElementById('changelog').value.trim();
    fetch('/api/client/version', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ version, download_url: downloadUrl, changelog })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') { alert('λ²„μ „μ΄ λ“±λ΅λμ—μµλ‹λ‹¤.'); document.getElementById('versionForm').reset(); loadVersions(); }
        else { alert('λ“±λ΅ μ‹¤ν¨: ' + data.message); }
    })
    .catch(error => { console.error('Error:', error); alert('λ“±λ΅ μ¤‘ μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤.'); });
});

function deleteVersion(id, version) {
    if (!confirm(`λ²„μ „ ${version}μ„(λ¥Ό) μ‚­μ ν•μ‹κ² μµλ‹κΉ?`)) return;
    fetch(`/api/client/version/${id}`, { method: 'DELETE' })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') { alert('λ²„μ „μ΄ μ‚­μ λμ—μµλ‹λ‹¤.'); loadVersions(); }
        else { alert('μ‚­μ  μ‹¤ν¨: ' + data.message); }
    })
    .catch(error => { console.error('Error:', error); alert('μ‚­μ  μ¤‘ μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤.'); });
}

loadVersions();
</script>
{% endblock %}