{% extends "base.html" %}

{% block title %}ν΄λΌμ΄μ–ΈνΈ λ²„μ „ κ΄€λ¦¬{% endblock %}

{% block content %}
<div style="max-width: 1400px; margin: 0 auto;">
    <h2 style="margin-bottom: 1.5em;">π“¦ ν΄λΌμ΄μ–ΈνΈ λ²„μ „ κ΄€λ¦¬</h2>

    <!-- λ²„μ „ λ“±λ΅ νΌ -->
    <div style="background: #2a2a2a; border-radius: 12px; padding: 1.5em; margin-bottom: 1.5em;">
        <h3 style="margin-top: 0; margin-bottom: 1em; font-size: 1.1em; color: #ddd;">μƒ λ²„μ „ λ“±λ΅</h3>
        <form id="versionForm">
            <div style="display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 1em; margin-bottom: 1em;">
                <div>
                    <label style="display: block; margin-bottom: 0.5em; font-weight: 500; color: #aaa;">λ²„μ „ *</label>
                    <input type="text" id="version" placeholder="0.7.0" required style="width: 100%; padding: 0.5em; border: 1px solid #444; border-radius: 6px; background: #1a1a1a; color: #ddd;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5em; font-weight: 500; color: #aaa;">λ‹¤μ΄λ΅λ“ URL *</label>
                    <input type="url" id="downloadUrl" placeholder="https://github.com/..." required style="width: 100%; padding: 0.5em; border: 1px solid #444; border-radius: 6px; background: #1a1a1a; color: #ddd;">
                </div>
                <div style="display: flex; align-items: flex-end;">
                    <button type="submit" style="width: 100%; padding: 0.5em 1em; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">λ“±λ΅</button>
                </div>
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5em; font-weight: 500; color: #aaa;">λ³€κ²½μ‚¬ν•­</label>
                <textarea id="changelog" rows="2" placeholder="μλ™ λΉλ“ - v0.7.0 λ¦΄λ¦¬μ¤" style="width: 100%; padding: 0.5em; border: 1px solid #444; border-radius: 6px; resize: vertical; background: #1a1a1a; color: #ddd;"></textarea>
            </div>
        </form>
    </div>

    <!-- λ²„μ „ λ©λ΅ -->
    <div style="background: #2a2a2a; border-radius: 12px; padding: 1.5em;">
        <h3 style="margin-top: 0; margin-bottom: 1em; font-size: 1.1em; color: #ddd;">λ“±λ΅λ λ²„μ „ λ©λ΅</h3>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 2px solid #444;">
                        <th style="padding: 0.75em; text-align: left; font-weight: 600; color: #aaa;">λ²„μ „</th>
                        <th style="padding: 0.75em; text-align: left; font-weight: 600; color: #aaa;">λ‹¤μ΄λ΅λ“ URL</th>
                        <th style="padding: 0.75em; text-align: left; font-weight: 600; color: #aaa;">λ³€κ²½μ‚¬ν•­</th>
                        <th style="padding: 0.75em; text-align: left; font-weight: 600; color: #aaa;">λ“±λ΅μΌμ‹</th>
                        <th style="padding: 0.75em; text-align: left; font-weight: 600; color: #aaa;">μ‘μ—…</th>
                    </tr>
                </thead>
                <tbody id="versionList">
                    <tr>
                        <td colspan="5" style="padding: 2em; text-align: center; color: #888;">λ΅λ”© μ¤‘...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// λ²„μ „ λ©λ΅ λ΅λ“
function loadVersions() {
    fetch('/api/client/versions')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('versionList');
            if (data.status === 'success' && data.versions.length > 0) {
                tbody.innerHTML = data.versions.map((v, index) => `
                    <tr style="border-bottom: 1px solid #444;">
                        <td style="padding: 0.75em; color: #ddd;">
                            <strong>${v.version}</strong>
                            ${index === 0 ? '<span style="display: inline-block; margin-left: 0.5em; padding: 0.25em 0.5em; background: #10b981; color: white; border-radius: 4px; font-size: 0.75em; font-weight: 600;">μµμ‹ </span>' : ''}
                        </td>
                        <td style="padding: 0.75em;"><a href="${v.download_url}" target="_blank" style="color: #60a5fa; text-decoration: none; max-width: 300px; display: inline-block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${v.download_url}</a></td>
                        <td style="padding: 0.75em; color: #aaa;">${v.changelog || '-'}</td>
                        <td style="padding: 0.75em; color: #aaa;">${new Date(v.released_at).toLocaleString('ko-KR')}</td>
                        <td style="padding: 0.75em;">
                            <button onclick="deleteVersion(${v.id}, '${v.version}')" style="padding: 0.25em 0.75em; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875em;">μ‚­μ </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="5" style="padding: 2em; text-align: center; color: #888;">λ“±λ΅λ λ²„μ „μ΄ μ—†μµλ‹λ‹¤</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('versionList').innerHTML = '<tr><td colspan="5" style="padding: 2em; text-align: center; color: #ef4444;">λ΅λ“ μ‹¤ν¨</td></tr>';
        });
}

// λ²„μ „ λ“±λ΅
document.getElementById('versionForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const version = document.getElementById('version').value.trim();
    const downloadUrl = document.getElementById('downloadUrl').value.trim();
    const changelog = document.getElementById('changelog').value.trim();

    fetch('/api/client/version', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            version: version,
            download_url: downloadUrl,
            changelog: changelog
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('λ²„μ „μ΄ λ“±λ΅λμ—μµλ‹λ‹¤.');
            document.getElementById('versionForm').reset();
            loadVersions();
        } else {
            alert('λ“±λ΅ μ‹¤ν¨: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('λ“±λ΅ μ¤‘ μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤.');
    });
});

// λ²„μ „ μ‚­μ 
function deleteVersion(id, version) {
    if (!confirm(`λ²„μ „ ${version}μ„(λ¥Ό) μ‚­μ ν•μ‹κ² μµλ‹κΉ?`)) {
        return;
    }

    fetch(`/api/client/version/${id}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('λ²„μ „μ΄ μ‚­μ λμ—μµλ‹λ‹¤.');
            loadVersions();
        } else {
            alert('μ‚­μ  μ‹¤ν¨: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('μ‚­μ  μ¤‘ μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤.');
    });
}

// νμ΄μ§€ λ΅λ“ μ‹ λ²„μ „ λ©λ΅ λ΅λ“
loadVersions();
</script>
{% endblock %}
