{% extends "base.html" %}
{% block title %}ì¢Œì„ ë°°ì¹˜ ì—ë””í„°{% endblock %}
{% block content %}
<h2>{{ room }} ì¢Œì„ ë°°ì¹˜ ì—ë””í„°</h2>

<div style="margin-bottom: 1em;">
    <button onclick="saveLayout()" style="background: #10b981; color: white; padding: 0.7em 1.5em; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">ğŸ’¾ ì €ì¥</button>
    <button onclick="goBack()" style="background: #666; color: white; padding: 0.7em 1.5em; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-left: 0.5em;">â¬…ï¸ ëŒì•„ê°€ê¸°</button>

    <span style="margin-left: 2em; color: #ddd;">í–‰:</span>
    <input type="number" id="rows" value="4" min="1" max="20" onchange="updateGrid()" style="width: 60px; padding: 0.5em; margin-left: 0.5em; background: #2a2a2a; color: white; border: 1px solid #444; border-radius: 4px;">

    <span style="margin-left: 1em; color: #ddd;">ì—´:</span>
    <input type="number" id="cols" value="10" min="1" max="20" onchange="updateGrid()" style="width: 60px; padding: 0.5em; margin-left: 0.5em; background: #2a2a2a; color: white; border: 1px solid #444; border-radius: 4px;">
</div>

<!-- ì¢Œì„ ë°°ì¹˜ ê·¸ë¦¬ë“œ -->
<div style="background: #2a2a2a; padding: 2em; border-radius: 10px; width: fit-content; margin-bottom: 2em;">
    <h3 style="margin-top: 0;">ì¢Œì„ ë°°ì¹˜</h3>
    <div id="layoutGrid" style="
        display: grid;
        grid-template-columns: repeat(10, 1fr);
        gap: 0.5em;
        width: fit-content;
    ">
    </div>
</div>

<!-- ë¯¸í• ë‹¹ PC ëª©ë¡ -->
<div style="background: #2a2a2a; padding: 2em; border-radius: 10px;">
    <h3 style="margin-top: 0;">í• ë‹¹ë˜ì§€ ì•Šì€ PC (ì•„ë˜ì—ì„œ ë“œë˜ê·¸í•´ì„œ ìœ„ì— ë†“ìœ¼ì„¸ìš”)</h3>
    <div id="unassignedPCs" style="
        display: flex;
        flex-wrap: wrap;
        gap: 1em;
        min-height: 60px;
        background: #1a1a1a;
        padding: 1em;
        border-radius: 8px;
        border: 2px dashed #444;
    ">
    </div>
</div>

<style>
.seat-cell {
    width: 80px;
    height: 80px;
    background: #1a1a1a;
    border: 2px solid #444;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    padding: 0.5em;
    text-align: center;
    font-size: 0.8em;
    box-sizing: border-box;
}

.seat-cell.occupied {
    background: #10b981;
    border: 2px solid #10b981;
}

.seat-cell.empty {
    background: #2a2a2a;
    border: 2px dashed #666;
}

.seat-cell:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(74, 158, 255, 0.5);
}

.seat-cell.drag-over {
    background: #4a9eff !important;
    border: 2px solid #4a9eff !important;
    box-shadow: inset 0 0 10px rgba(74, 158, 255, 0.5);
}

.pc-badge {
    background: #4a9eff;
    color: white;
    padding: 0.5em 1em;
    border-radius: 6px;
    cursor: grab;
    user-select: none;
    font-weight: 600;
    transition: all 0.3s;
}

.pc-badge:active {
    cursor: grabbing;
}

.pc-badge:hover {
    background: #3a8eef;
    transform: scale(1.05);
}

#unassignedPCs.drag-over {
    background: rgba(74, 158, 255, 0.2) !important;
    border: 2px dashed #4a9eff !important;
}
</style>

<script>
const room = "{{ room }}";
const allPCs = {{ pcs|tojson }}.concat({{ unassigned|tojson }});
let layoutData = [];
let layoutConfig = { rows: 4, cols: 10 };
let draggedPC = null;

function initLayout() {
    fetch(`/api/layout/map/${room}`)
        .then(res => res.json())
        .then(data => {
            layoutData = data.seats || [];
            layoutConfig = { rows: data.rows, cols: data.cols };
            document.getElementById('rows').value = data.rows;
            document.getElementById('cols').value = data.cols;
            renderGrid();
            renderUnassigned();
        })
        .catch(error => {
            console.error('Error:', error);
            renderGrid();
            renderUnassigned();
        });
}

function updateGrid() {
    layoutConfig.rows = parseInt(document.getElementById('rows').value);
    layoutConfig.cols = parseInt(document.getElementById('cols').value);
    renderGrid();
}

function renderGrid() {
    const grid = document.getElementById('layoutGrid');
    grid.style.gridTemplateColumns = `repeat(${layoutConfig.cols}, 1fr)`;
    grid.innerHTML = '';

    const pcMap = {};
    allPCs.forEach(pc => {
        pcMap[pc.id] = pc;
    });

    for (let row = 0; row < layoutConfig.rows; row++) {
        for (let col = 0; col < layoutConfig.cols; col++) {
            const seat = layoutData.find(s => s.row === row && s.col === col);
            const pc = seat && seat.pc_id ? pcMap[seat.pc_id] : null;

            const div = document.createElement('div');
            div.className = `seat-cell ${pc ? 'occupied' : 'empty'}`;
            div.dataset.row = row;
            div.dataset.col = col;

            div.addEventListener('dragover', handleDragOver);
            div.addEventListener('dragleave', handleDragLeave);
            div.addEventListener('drop', (e) => handleDrop(e, row, col));

            if (pc) {
                const color = !pc.is_online ? '#555' :
                             (pc.cpu_usage && pc.cpu_usage > 90) ? '#dc2626' :
                             (pc.cpu_usage && pc.cpu_usage > 75) ? '#f59e0b' : '#10b981';

                div.style.background = color;
                div.style.borderColor = color;

                div.innerHTML = `
                    <div style="font-weight: bold; color: white; font-size: 0.9em;">
                        ${pc.seat_number || pc.id}
                    </div>
                    <div style="font-size: 0.75em; color: #ddd;">
                        ${pc.hostname || 'PC-' + pc.id}
                    </div>
                    <div style="font-size: 0.65em; color: #ccc; cursor: grab; margin-top: 0.3em;">
                        ğŸ“Œ ë“œë˜ê·¸
                    </div>
                `;

                div.draggable = true;
                div.addEventListener('dragstart', (e) => handleDragStart(e, pc.id));
            } else {
                div.innerHTML = `
                    <div style="color: #666; font-size: 0.8em; line-height: 1.4;">
                        ë¹ˆ ì¹¸<br>
                        <small>(PCë¥¼ ì—¬ê¸°ì— ë“œë¡­)</small>
                    </div>
                `;
            }

            grid.appendChild(div);
        }
    }
}

function renderUnassigned() {
    const container = document.getElementById('unassignedPCs');
    const assignedPCIds = layoutData.filter(s => s.pc_id).map(s => s.pc_id);
    const unassigned = allPCs.filter(pc => !assignedPCIds.includes(pc.id));

    container.innerHTML = unassigned.length === 0
        ? '<div style="color: #888;">ëª¨ë“  PCê°€ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤! âœ“</div>'
        : unassigned.map(pc => `
            <div class="pc-badge" draggable="true" data-pc-id="${pc.id}">
                [${pc.seat_number || pc.id}] ${pc.hostname || 'PC-' + pc.id}
            </div>
        `).join('');

    document.querySelectorAll('#unassignedPCs .pc-badge').forEach(badge => {
        badge.addEventListener('dragstart', (e) => {
            draggedPC = parseInt(e.target.dataset.pcId);
            e.dataTransfer.effectAllowed = 'move';
        });
    });

    container.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        container.classList.add('drag-over');
    });

    container.addEventListener('dragleave', () => {
        container.classList.remove('drag-over');
    });

    container.addEventListener('drop', (e) => {
        e.preventDefault();
        container.classList.remove('drag-over');
        if (draggedPC) {
            removeSeatByPC(draggedPC);
            draggedPC = null;
        }
    });
}

function handleDragStart(e, pcId) {
    draggedPC = pcId;
    e.dataTransfer.effectAllowed = 'move';
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    e.target.classList.add('drag-over');
}

function handleDragLeave(e) {
    e.target.classList.remove('drag-over');
}

function handleDrop(e, row, col) {
    e.preventDefault();
    e.target.classList.remove('drag-over');

    if (draggedPC) {
        layoutData = layoutData.filter(s => s.pc_id !== draggedPC);
        layoutData.push({ room_name: room, row, col, pc_id: draggedPC });

        renderGrid();
        renderUnassigned();
        draggedPC = null;
    }
}

function removeSeatByPC(pcId) {
    layoutData = layoutData.filter(s => s.pc_id !== pcId);
    renderGrid();
    renderUnassigned();
}

function saveLayout() {
    fetch(`/api/layout/map/${room}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            rows: layoutConfig.rows,
            cols: layoutConfig.cols,
            seats: layoutData.filter(s => s.pc_id)
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            alert('ë°°ì¹˜ ì €ì¥ ì™„ë£Œ!');
            window.location.href = `/?room=${room}`;
        } else {
            alert('ì˜¤ë¥˜: ' + (data.message || 'ì €ì¥ ì‹¤íŒ¨'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

function goBack() {
    window.location.href = `/?room=${room}`;
}

initLayout();
</script>
{% endblock %}
