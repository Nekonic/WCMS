{% extends "base.html" %}
{% block title %}등록 토큰 관리 - WCMS{% endblock %}
{% block content %}
<div class="header">
    <h1><i class="fas fa-key"></i> 등록 토큰 관리</h1>
    <p class="page-subtitle">PC 등록용 PIN 코드 생성 및 관리 (v0.8.0)</p>
</div>

<div class="content">
    <!-- 토큰 생성 폼 -->
    <div class="card section-card">
        <h2 style="margin-bottom: 1em;"><i class="fas fa-plus-circle"></i> 새 토큰 생성</h2>
        <form id="createTokenForm" class="form-grid-3" style="align-items: end;">
            <div>
                <label for="usageType" class="form-label">사용 유형</label>
                <select id="usageType" name="usage_type" class="form-input">
                    <option value="single">1회용 (Single-use)</option>
                    <option value="multi" selected>재사용 가능 (Multi-use)</option>
                </select>
            </div>
            <div>
                <label for="expiresIn" class="form-label">만료 시간 (분)</label>
                <input type="number" id="expiresIn" name="expires_in" value="10" min="1" max="1440" class="form-input">
            </div>
            <div>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 0.8em;">
                    <i class="fas fa-key"></i> 토큰 생성
                </button>
            </div>
        </form>
    </div>

    <!-- 생성된 토큰 표시 -->
    <div id="newTokenDisplay" style="display: none; margin-bottom: 2em;">
        <div class="card token-display-card">
            <h2 style="margin-bottom: 0.5em; color: #fff;"><i class="fas fa-check-circle"></i> 토큰 생성 완료!</h2>
            <p style="margin-bottom: 1em; color: #bfdbfe;">아래 PIN을 install.cmd 실행 시 입력하세요:</p>
            <div class="token-pin-display">
                <div class="token-pin-text" id="tokenPIN">------</div>
            </div>
            <div class="token-meta">
                <div><strong>유형:</strong> <span id="tokenType">-</span></div>
                <div><strong>만료:</strong> <span id="tokenExpires">-</span></div>
            </div>
            <button onclick="copyToken()" class="btn btn-primary" style="margin-top: 1em; width: 100%;">
                <i class="fas fa-copy"></i> PIN 복사
            </button>
        </div>
    </div>

    <!-- 활성 토큰 목록 -->
    <div class="card">
        <div class="flex-between" style="margin-bottom: 1.5em;">
            <h2><i class="fas fa-list"></i> 활성 토큰 목록</h2>
            <button onclick="loadTokens()" class="btn btn-secondary" style="padding: 0.6em 1em;">
                <i class="fas fa-sync-alt"></i> 새로고침
            </button>
        </div>

        <div id="tokensLoading" class="loading-state">
            <i class="fas fa-spinner fa-spin loading-icon"></i>
            <p style="margin-top: 1em;">토큰 목록을 불러오는 중...</p>
        </div>

        <div id="tokensContainer" style="display: none;">
            <div id="tokensTable"></div>
        </div>

        <div id="tokensEmpty" class="empty-state" style="display: none;">
            <i class="fas fa-inbox empty-icon"></i>
            <p>활성 토큰이 없습니다.</p>
            <p style="font-size: 0.9em; margin-top: 0.5em;">위에서 새 토큰을 생성하세요.</p>
        </div>
    </div>
</div>

<script>
let currentToken = null;

document.addEventListener('DOMContentLoaded', function() { loadTokens(); });

document.getElementById('createTokenForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const usageType = document.getElementById('usageType').value;
    const expiresIn = parseInt(document.getElementById('expiresIn').value) * 60;
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 생성 중...';
    try {
        const response = await fetch('/api/admin/registration-token', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ usage_type: usageType, expires_in: expiresIn })
        });
        const data = await response.json();
        if (response.ok && data.status === 'success') {
            currentToken = data.token;
            document.getElementById('tokenPIN').textContent = data.token;
            document.getElementById('tokenType').textContent = data.usage_type === 'single' ? '1회용' : '재사용 가능';
            document.getElementById('tokenExpires').textContent = new Date(data.expires_at).toLocaleString('ko-KR');
            document.getElementById('newTokenDisplay').style.display = 'block';
            loadTokens();
            this.reset();
            document.getElementById('usageType').value = 'multi';
        } else {
            alert('토큰 생성 실패: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('토큰 생성 중 오류가 발생했습니다.');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-key"></i> 토큰 생성';
    }
});

async function loadTokens() {
    document.getElementById('tokensLoading').style.display = 'block';
    document.getElementById('tokensContainer').style.display = 'none';
    document.getElementById('tokensEmpty').style.display = 'none';
    try {
        const response = await fetch('/api/admin/registration-tokens');
        const data = await response.json();
        if (response.ok && data.status === 'success') {
            const tokens = data.tokens;
            if (tokens.length === 0) {
                document.getElementById('tokensLoading').style.display = 'none';
                document.getElementById('tokensEmpty').style.display = 'block';
            } else {
                displayTokens(tokens);
                document.getElementById('tokensLoading').style.display = 'none';
                document.getElementById('tokensContainer').style.display = 'block';
            }
        } else {
            throw new Error(data.message || '토큰 목록 불러오기 실패');
        }
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('tokensLoading').innerHTML =
            '<p class="text-error"><i class="fas fa-exclamation-circle"></i> 오류: ' + error.message + '</p>';
    }
}

function displayTokens(tokens) {
    const html = `
        <table class="token-table">
            <thead>
                <tr>
                    <th>PIN</th><th>유형</th><th>사용 횟수</th><th>만료 시간</th><th>생성자</th><th>작업</th>
                </tr>
            </thead>
            <tbody>
                ${tokens.map(token => `
                    <tr>
                        <td><span class="token-pin">${token.token}</span></td>
                        <td>
                            <span class="badge ${token.usage_type === 'single' ? 'badge-single' : 'badge-multi'}">
                                ${token.usage_type === 'single' ? '1회용' : '재사용'}
                            </span>
                        </td>
                        <td>${token.used_count}회</td>
                        <td>${new Date(token.expires_at).toLocaleString('ko-KR')}</td>
                        <td>${token.created_by}</td>
                        <td>
                            <button onclick="deleteToken(${token.id})" class="btn btn-danger" style="padding: 0.5em 1em; font-size: 0.85em;">
                                <i class="fas fa-trash"></i> 삭제
                            </button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    document.getElementById('tokensTable').innerHTML = html;
}

async function deleteToken(tokenId) {
    if (!confirm(`토큰을 삭제하시겠습니까?`)) return;
    try {
        const response = await fetch(`/api/admin/registration-token/${tokenId}`, { method: 'DELETE' });
        const data = await response.json();
        if (response.ok && data.status === 'success') { alert('토큰이 삭제되었습니다.'); loadTokens(); }
        else { alert('삭제 실패: ' + data.message); }
    } catch (error) {
        console.error('Error:', error);
        alert('토큰 삭제 중 오류가 발생했습니다.');
    }
}

function copyToken() {
    if (!currentToken) return;
    navigator.clipboard.writeText(currentToken).then(() => {
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> 복사됨!';
        btn.style.background = '#10b981';
        setTimeout(() => { btn.innerHTML = originalHTML; btn.style.background = ''; }, 2000);
    });
}
</script>
{% endblock %}