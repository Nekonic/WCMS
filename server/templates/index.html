{% extends "base.html" %}
{% block title %}{{ room or 'ì‹¤ìŠµì‹¤' }} PC ëª©ë¡{% endblock %}
{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5em;">
    <h2 style="margin: 0;">{{ room or 'ì‹¤ìŠµì‹¤' }} PC ëª©ë¡</h2>
    {% if admin %}
    <a href="/layout/editor?room={{ room }}" style="
        background: #4a9eff;
        color: white;
        padding: 0.7em 1.5em;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s;
    " onmouseover="this.style.background='#3a8eef'" onmouseout="this.style.background='#4a9eff'">
        âš™ï¸ ë°°ì¹˜ í¸ì§‘
    </a>
    {% endif %}
</div>

<!-- ë²”ë¡€ ë° ì¼ê´„ ëª…ë ¹ ì»¨íŠ¸ë¡¤ -->
<div style="display: flex; gap: 2em; margin-bottom: 2em; padding: 1em; background: #2a2a2a; border-radius: 8px; flex-wrap: wrap; justify-content: space-between; align-items: center;">
    <div style="display: flex; gap: 2em; flex-wrap: wrap;">
        <div style="display: flex; align-items: center; gap: 0.5em;">
            <div style="width: 30px; height: 30px; background: #10b981; border-radius: 4px;"></div>
            <span>ì •ìƒ (CPU < 75%)</span>
        </div>
        <div style="display: flex; align-items: center; gap: 0.5em;">
            <div style="width: 30px; height: 30px; background: #f59e0b; border-radius: 4px;"></div>
            <span>ê²½ê³  (CPU 75~90%)</span>
        </div>
        <div style="display: flex; align-items: center; gap: 0.5em;">
            <div style="width: 30px; height: 30px; background: #dc2626; border-radius: 4px;"></div>
            <span>ìœ„í—˜ (CPU > 90%)</span>
        </div>
        <div style="display: flex; align-items: center; gap: 0.5em;">
            <div style="width: 30px; height: 30px; background: #555; border-radius: 4px;"></div>
            <span>ì˜¤í”„ë¼ì¸</span>
        </div>
    </div>

    {% if admin %}
    <div style="display: flex; gap: 1em; align-items: center;">
        <button onclick="toggleSelectionMode()" id="selectionModeBtn" style="
            background: #6366f1;
            color: white;
            padding: 0.6em 1.2em;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        ">
            ğŸ“‹ ì„ íƒ ëª¨ë“œ
        </button>
        <button onclick="selectAllOnlinePCs()" style="
            background: #8b5cf6;
            color: white;
            padding: 0.6em 1.2em;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        ">
            âœ“ ì˜¨ë¼ì¸ PC ì „ì²´ ì„ íƒ
        </button>
    </div>
    {% endif %}
</div>

<!-- ì„ íƒëœ PC íŒ¨ë„ -->
<div id="selectedPCsPanel" style="display: none; margin-bottom: 1.5em; padding: 1.5em; background: #1e3a8a; border-radius: 8px; border: 2px solid #3b82f6;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em;">
        <h3 style="margin: 0; color: white;">
            <span id="selectedCount">0</span>ëŒ€ ì„ íƒë¨
        </h3>
        <button onclick="clearSelection()" style="
            background: #dc2626;
            color: white;
            padding: 0.5em 1em;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        ">
            ì„ íƒ í•´ì œ
        </button>
    </div>

    <div id="selectedPCsList" style="
        display: flex;
        flex-wrap: wrap;
        gap: 0.5em;
        margin-bottom: 1em;
        padding: 1em;
        background: rgba(255,255,255,0.1);
        border-radius: 6px;
        max-height: 150px;
        overflow-y: auto;
    ">
        <!-- ì„ íƒëœ PC ëª©ë¡ ë™ì  ìƒì„± -->
    </div>

    <div style="display: flex; gap: 0.8em; flex-wrap: wrap;">
        <button onclick="showBulkCMDModal()" style="
            background: #10b981;
            color: white;
            padding: 0.7em 1.2em;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5em;
        ">
            <i class="fas fa-terminal"></i> CMD ì‹¤í–‰
        </button>
        <button onclick="showBulkWingetModal()" style="
            background: #3b82f6;
            color: white;
            padding: 0.7em 1.2em;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5em;
        ">
            <i class="fas fa-download"></i> í”„ë¡œê·¸ë¨ ì„¤ì¹˜
        </button>
        <button onclick="showBulkFileDownloadModal()" style="
            background: #8b5cf6;
            color: white;
            padding: 0.7em 1.2em;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5em;
        ">
            <i class="fas fa-file-download"></i> íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        </button>
        <button onclick="showBulkAccountModal()" style="
            background: #f59e0b;
            color: white;
            padding: 0.7em 1.2em;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5em;
        ">
            <i class="fas fa-user-cog"></i> ê³„ì • ê´€ë¦¬
        </button>
        <button onclick="showBulkPowerModal()" style="
            background: #dc2626;
            color: white;
            padding: 0.7em 1.2em;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5em;
        ">
            <i class="fas fa-power-off"></i> ì „ì› ê´€ë¦¬
        </button>
    </div>
</div>

<!-- ì¢Œì„ ë°°ì¹˜ë„ (ê·¸ë¦¬ë“œ) -->
<div style="margin-bottom: 2em; background: #2a2a2a; padding: 2em; border-radius: 10px; width: fit-content;">
    <div id="layoutGrid" style="
        display: grid;
        grid-template-columns: repeat(10, 1fr);
        gap: 0.5em;
        width: fit-content;
    ">
        <!-- JavaScriptì—ì„œ ë™ì  ìƒì„± -->
    </div>
</div>

<style>
.seat-cell {
    width: 80px;
    height: 80px;
    background: #1a1a1a;
    border: 2px solid #444;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    padding: 0.5em;
    text-align: center;
    font-size: 0.8em;
    box-sizing: border-box;
    position: relative;
    user-select: none;
}

.seat-cell.occupied {
    background: #10b981;
    border: 2px solid #10b981;
}

.seat-cell.empty {
    background: #2a2a2a;
    border: 2px dashed #666;
}

.seat-cell:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(74, 158, 255, 0.5);
}

.seat-cell.selected {
    border: 3px solid #fbbf24 !important;
    box-shadow: 0 0 15px rgba(251, 191, 36, 0.6) !important;
}

.seat-checkbox {
    position: absolute;
    top: 4px;
    left: 4px;
    width: 20px;
    height: 20px;
    background: white;
    border: 2px solid #333;
    border-radius: 4px;
    display: none;
    cursor: pointer;
}

.seat-cell.selection-mode .seat-checkbox {
    display: block;
}

.seat-checkbox.checked {
    background: #fbbf24;
    border-color: #f59e0b;
}

.seat-checkbox.checked::after {
    content: 'âœ“';
    color: #000;
    font-size: 14px;
    font-weight: bold;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

.selected-pc-tag {
    background: rgba(255,255,255,0.2);
    color: white;
    padding: 0.4em 0.8em;
    border-radius: 6px;
    font-size: 0.85em;
    display: flex;
    align-items: center;
    gap: 0.5em;
}

.selected-pc-tag .remove-btn {
    background: rgba(220, 38, 38, 0.8);
    color: white;
    border: none;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
    padding: 0;
}
</style>

<script>
const room = "{{ room }}";
const allPCs = {{ pcs|tojson }};
let selectedPCs = new Set();
let selectionMode = false;
let isDragging = false;
let dragStartPos = null;

// ì„ íƒ ëª¨ë“œ í† ê¸€
function toggleSelectionMode() {
    selectionMode = !selectionMode;
    const btn = document.getElementById('selectionModeBtn');
    const cells = document.querySelectorAll('.seat-cell.occupied');

    if (selectionMode) {
        btn.style.background = '#dc2626';
        btn.textContent = 'âœ– ì„ íƒ ëª¨ë“œ ì¢…ë£Œ';
        cells.forEach(cell => cell.classList.add('selection-mode'));
    } else {
        btn.style.background = '#6366f1';
        btn.textContent = 'ğŸ“‹ ì„ íƒ ëª¨ë“œ';
        cells.forEach(cell => cell.classList.remove('selection-mode'));
        clearSelection();
    }
}

// PC ì„ íƒ/í•´ì œ
function togglePCSelection(pcId, event) {
    if (event) event.stopPropagation();

    if (selectedPCs.has(pcId)) {
        selectedPCs.delete(pcId);
    } else {
        selectedPCs.add(pcId);
    }
    updateSelectionUI();
}

// ì „ì²´ ì˜¨ë¼ì¸ PC ì„ íƒ
function selectAllOnlinePCs() {
    if (!selectionMode) toggleSelectionMode();

    allPCs.forEach(pc => {
        if (pc.is_online) {
            selectedPCs.add(pc.id);
        }
    });
    updateSelectionUI();
}

// ì„ íƒ í•´ì œ
function clearSelection() {
    selectedPCs.clear();
    updateSelectionUI();
}

// ì„ íƒ UI ì—…ë°ì´íŠ¸
function updateSelectionUI() {
    const panel = document.getElementById('selectedPCsPanel');
    const count = document.getElementById('selectedCount');
    const list = document.getElementById('selectedPCsList');

    count.textContent = selectedPCs.size;

    if (selectedPCs.size > 0) {
        panel.style.display = 'block';

        // ì„ íƒëœ PC ëª©ë¡ í‘œì‹œ
        list.innerHTML = '';
        selectedPCs.forEach(pcId => {
            const pc = allPCs.find(p => p.id === pcId);
            if (pc) {
                const tag = document.createElement('div');
                tag.className = 'selected-pc-tag';
                tag.innerHTML = `
                    <span>${pc.seat_number || pc.hostname}</span>
                    <button class="remove-btn" onclick="togglePCSelection(${pcId}, event)">Ã—</button>
                `;
                list.appendChild(tag);
            }
        });
    } else {
        panel.style.display = 'none';
    }

    // ì¢Œì„ ì…€ ì²´í¬ë°•ìŠ¤ ì—…ë°ì´íŠ¸
    document.querySelectorAll('.seat-cell.occupied').forEach(cell => {
        const pcId = parseInt(cell.dataset.pcId);
        const checkbox = cell.querySelector('.seat-checkbox');
        if (checkbox) {
            if (selectedPCs.has(pcId)) {
                cell.classList.add('selected');
                checkbox.classList.add('checked');
            } else {
                cell.classList.remove('selected');
                checkbox.classList.remove('checked');
            }
        }
    });
}

// ë“œë˜ê·¸ ì„ íƒ
function handleMouseDown(pcId, row, col) {
    if (!selectionMode) return;
    isDragging = true;
    dragStartPos = { row, col };
}

function handleMouseOver(pcId, row, col) {
    if (!selectionMode || !isDragging || !dragStartPos) return;

    // ë“œë˜ê·¸ ë²”ìœ„ ë‚´ì˜ ëª¨ë“  PC ì„ íƒ
    const minRow = Math.min(dragStartPos.row, row);
    const maxRow = Math.max(dragStartPos.row, row);
    const minCol = Math.min(dragStartPos.col, col);
    const maxCol = Math.max(dragStartPos.col, col);

    document.querySelectorAll('.seat-cell.occupied').forEach(cell => {
        const cellRow = parseInt(cell.dataset.row);
        const cellCol = parseInt(cell.dataset.col);
        const cellPcId = parseInt(cell.dataset.pcId);

        if (cellRow >= minRow && cellRow <= maxRow &&
            cellCol >= minCol && cellCol <= maxCol) {
            selectedPCs.add(cellPcId);
        }
    });

    updateSelectionUI();
}

function handleMouseUp() {
    isDragging = false;
    dragStartPos = null;
}

// ì „ì—­ ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
document.addEventListener('mouseup', handleMouseUp);

function renderLayout() {
    fetch(`/api/layout/map/${room}`)
        .then(res => res.json())
        .then(data => {
            const grid = document.getElementById('layoutGrid');
            grid.style.gridTemplateColumns = `repeat(${data.cols}, 1fr)`;
            grid.innerHTML = '';

            // PC ë§µ ìƒì„±
            const pcMap = {};
            allPCs.forEach(pc => {
                pcMap[pc.id] = pc;
            });

            // ì…€ ë Œë”ë§
            for (let row = 0; row < data.rows; row++) {
                for (let col = 0; col < data.cols; col++) {
                    const seat = data.seats.find(s => s.row === row && s.col === col);
                    const pc = seat && seat.pc_id ? pcMap[seat.pc_id] : null;

                    const div = document.createElement('div');
                    div.className = `seat-cell ${pc ? 'occupied' : 'empty'}`;

                    if (pc) {
                        div.dataset.pcId = pc.id;
                        div.dataset.row = row;
                        div.dataset.col = col;

                        const color = !pc.is_online ? '#555' :
                                     (pc.cpu_usage && pc.cpu_usage > 90) ? '#dc2626' :
                                     (pc.cpu_usage && pc.cpu_usage > 75) ? '#f59e0b' : '#10b981';

                        div.style.background = color;
                        div.style.borderColor = color;

                        div.innerHTML = `
                            <div class="seat-checkbox"></div>
                            <div style="font-weight: bold; color: white; font-size: 0.9em;">
                                ${pc.seat_number}
                            </div>
                            <div style="font-size: 0.75em; color: #ddd;">
                                ${pc.hostname}
                            </div>
                            <div style="font-size: 0.65em; color: #ccc;">
                                ${!pc.is_online ? 'ì˜¤í”„ë¼ì¸' :
                                  pc.cpu_usage ? `CPU: ${Math.round(pc.cpu_usage)}%` : 'ì˜¨ë¼ì¸'}
                            </div>
                        `;

                        // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
                        div.onclick = (e) => {
                            if (selectionMode) {
                                togglePCSelection(pc.id, e);
                            } else {
                                openModal(pc.id);
                            }
                        };

                        div.onmousedown = () => handleMouseDown(pc.id, row, col);
                        div.onmouseover = () => handleMouseOver(pc.id, row, col);
                    } else {
                        div.innerHTML = '<div style="color: #666; font-size: 0.8em;">ë¹ˆ ì¹¸</div>';
                    }

                    grid.appendChild(div);
                }
            }
        })
        .catch(error => {
            console.error('Error loading layout:', error);
            alert('ë°°ì¹˜ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        });
}

renderLayout();

// ==================== ì¼ê´„ ëª…ë ¹ ëª¨ë‹¬ í•¨ìˆ˜ ====================

function showBulkCMDModal() {
    const cmd = prompt('ì‹¤í–‰í•  CMD ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”:\n\nì˜ˆì‹œ:\n- hostname\n- whoami\n- ipconfig\n- dir');
    if (!cmd) return;

    executeBulkCommand('execute', { command: cmd });
}

function showBulkWingetModal() {
    const appId = prompt('ì„¤ì¹˜í•  í”„ë¡œê·¸ë¨ì˜ winget App IDë¥¼ ì…ë ¥í•˜ì„¸ìš”:\n\nì˜ˆì‹œ:\n- Notepad++.Notepad++\n- 7zip.7zip\n- VideoLAN.VLC\n- Google.Chrome');
    if (!appId) return;

    executeBulkCommand('install', { app_id: appId });
}

function showBulkFileDownloadModal() {
    const url = prompt('ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ì˜ URLì„ ì…ë ¥í•˜ì„¸ìš”:');
    if (!url) return;

    const path = prompt('ì €ì¥í•  ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”:\n(ì˜ˆ: C:\\\\temp\\\\file.zip)', 'C:\\\\temp\\\\download.txt');
    if (!path) return;

    executeBulkCommand('download', { url, destination: path });
}

function showBulkAccountModal() {
    const action = prompt('ê³„ì • ê´€ë¦¬ ì‘ì—…ì„ ì„ íƒí•˜ì„¸ìš”:\n\n1. create (ê³„ì • ìƒì„±)\n2. delete (ê³„ì • ì‚­ì œ)\n3. change_password (ë¹„ë°€ë²ˆí˜¸ ë³€ê²½)');
    if (!action || !['create', 'delete', 'change_password'].includes(action)) {
        alert('ì˜¬ë°”ë¥¸ ì‘ì—…ì„ ì…ë ¥í•˜ì„¸ìš” (create, delete, change_password)');
        return;
    }

    const username = prompt('ì‚¬ìš©ì ì´ë¦„:');
    if (!username) return;

    let password = null;
    if (action === 'create' || action === 'change_password') {
        password = prompt('ë¹„ë°€ë²ˆí˜¸:');
        if (!password) return;
    }

    executeBulkCommand('account', { action, username, password });
}

function showBulkPowerModal() {
    const action = prompt('ì „ì› ê´€ë¦¬ ì‘ì—…ì„ ì„ íƒí•˜ì„¸ìš”:\n\n1. shutdown (ì¢…ë£Œ)\n2. restart (ì¬ì‹œì‘)\n3. logout (ë¡œê·¸ì•„ì›ƒ)');
    if (!action || !['shutdown', 'restart', 'logout'].includes(action)) {
        alert('ì˜¬ë°”ë¥¸ ì‘ì—…ì„ ì…ë ¥í•˜ì„¸ìš” (shutdown, restart, logout)');
        return;
    }

    const confirmed = confirm(`ì„ íƒëœ ${selectedPCs.size}ëŒ€ì˜ PCë¥¼ ${action} í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
    if (!confirmed) return;

    executeBulkCommand('power', { action });
}

async function executeBulkCommand(commandType, commandData) {
    if (selectedPCs.size === 0) {
        alert('ì„ íƒëœ PCê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    const pcIds = Array.from(selectedPCs);

    if (!confirm(`ì„ íƒëœ ${pcIds.length}ëŒ€ì˜ PCì— ëª…ë ¹ì„ ì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }

    try {
        const response = await fetch('/api/pcs/bulk-command', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                pc_ids: pcIds,
                command_type: commandType,
                command_data: commandData
            })
        });

        const result = await response.json();

        if (response.ok) {
            alert(`âœ… ëª…ë ¹ ì „ì†¡ ì™„ë£Œ\n\n` +
                  `ì´ ${result.total}ëŒ€ ì¤‘ ${result.success}ëŒ€ ì„±ê³µ, ${result.failed}ëŒ€ ì‹¤íŒ¨`);

            // ì„ íƒ í•´ì œ
            if (result.success > 0) {
                clearSelection();
            }
        } else {
            alert(`âŒ ëª…ë ¹ ì „ì†¡ ì‹¤íŒ¨: ${result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
        }
    } catch (error) {
        console.error('Bulk command error:', error);
        alert('ëª…ë ¹ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// PC ìƒì„¸ ëª¨ë‹¬ (ê¸°ì¡´ í•¨ìˆ˜ ìœ ì§€)
function openModal(pcId) {
    window.location.href = `/pc/${pcId}`;
}
</script>
{% endblock %}
