{% extends "base.html" %}
{% block title %}ì‹œìŠ¤í…œ ìƒíƒœ{% endblock %}
{% block content %}
<div style="max-width: 1400px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2em;">
        <h2 style="margin: 0;">ğŸ” ì‹œìŠ¤í…œ ìƒíƒœ ëª¨ë‹ˆí„°ë§</h2>
        <div style="display: flex; gap: 1em;">
            <button onclick="forceCheck()" style="
                background: #f59e0b;
                color: white;
                padding: 0.7em 1.5em;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 600;
            ">
                âš¡ ê°•ì œ ì²´í¬
            </button>
            <button onclick="refreshStatus()" style="
                background: #10b981;
                color: white;
                padding: 0.7em 1.5em;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 600;
            ">
                ğŸ”„ ìƒˆë¡œê³ ì¹¨
            </button>
        </div>
    </div>

    <!-- ìš”ì•½ í†µê³„ -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5em; margin-bottom: 2em;">
        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 1.5em; border-radius: 10px; color: white;">
            <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 0.5em;">ì˜¨ë¼ì¸ PC</div>
            <div style="font-size: 2.5em; font-weight: bold;" id="onlineCount">0</div>
        </div>
        <div style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); padding: 1.5em; border-radius: 10px; color: white;">
            <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 0.5em;">ì˜¤í”„ë¼ì¸ PC</div>
            <div style="font-size: 2.5em; font-weight: bold;" id="offlineCount">0</div>
        </div>
        <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); padding: 1.5em; border-radius: 10px; color: white;">
            <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 0.5em;">ì „ì²´ PC</div>
            <div style="font-size: 2.5em; font-weight: bold;" id="totalCount">0</div>
        </div>
        <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); padding: 1.5em; border-radius: 10px; color: white;">
            <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 0.5em;">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</div>
            <div style="font-size: 1.2em; font-weight: bold;" id="lastUpdate">-</div>
        </div>
    </div>

    <!-- í•„í„° -->
    <div style="background: #2a2a2a; padding: 1em; border-radius: 8px; margin-bottom: 1.5em;">
        <div style="display: flex; gap: 1em; align-items: center; flex-wrap: wrap;">
            <label style="color: #aaa;">í•„í„°:</label>
            <button onclick="filterStatus('all')" id="filterAll" class="filter-btn active">ì „ì²´</button>
            <button onclick="filterStatus('online')" id="filterOnline" class="filter-btn">ì˜¨ë¼ì¸ë§Œ</button>
            <button onclick="filterStatus('offline')" id="filterOffline" class="filter-btn">ì˜¤í”„ë¼ì¸ë§Œ</button>
        </div>
    </div>

    <!-- PC ìƒíƒœ í…Œì´ë¸” -->
    <div style="background: #2a2a2a; border-radius: 10px; overflow: hidden;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #1a1a1a; border-bottom: 2px solid #444;">
                    <th style="padding: 1em; text-align: left; color: #aaa; font-weight: 600;">ìƒíƒœ</th>
                    <th style="padding: 1em; text-align: left; color: #aaa; font-weight: 600;">í˜¸ìŠ¤íŠ¸ëª…</th>
                    <th style="padding: 1em; text-align: left; color: #aaa; font-weight: 600;">Machine ID</th>
                    <th style="padding: 1em; text-align: left; color: #aaa; font-weight: 600;">ë§ˆì§€ë§‰ í•˜íŠ¸ë¹„íŠ¸</th>
                    <th style="padding: 1em; text-align: left; color: #aaa; font-weight: 600;">ê²½ê³¼ ì‹œê°„</th>
                    <th style="padding: 1em; text-align: left; color: #aaa; font-weight: 600;">ì„œë²„ ì‹œê°„</th>
                </tr>
            </thead>
            <tbody id="pcStatusTable">
                <!-- ë™ì  ìƒì„± -->
            </tbody>
        </table>
    </div>
</div>

<style>
.filter-btn {
    background: #444;
    color: white;
    border: none;
    padding: 0.6em 1.2em;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
}

.filter-btn:hover {
    background: #555;
}

.filter-btn.active {
    background: #4a9eff;
}

.status-badge {
    display: inline-block;
    padding: 0.4em 0.8em;
    border-radius: 12px;
    font-size: 0.85em;
    font-weight: 600;
}

.status-online {
    background: #10b981;
    color: white;
}

.status-offline {
    background: #6b7280;
    color: white;
}

.status-warning {
    background: #f59e0b;
    color: white;
}

tr.pc-row {
    border-bottom: 1px solid #333;
    transition: background 0.2s;
}

tr.pc-row:hover {
    background: rgba(74, 158, 255, 0.1);
}

tr.pc-row td {
    padding: 1em;
    color: #e0e0e0;
}
</style>

<script>
let allPCs = [];
let currentFilter = 'all';

async function loadStatus() {
    try {
        const response = await fetch('/api/debug/pc-status');
        const data = await response.json();

        allPCs = data.pcs;

        // í†µê³„ ì—…ë°ì´íŠ¸
        document.getElementById('onlineCount').textContent = data.online_count;
        document.getElementById('offlineCount').textContent = data.offline_count;
        document.getElementById('totalCount').textContent = data.total;
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('ko-KR');

        // í…Œì´ë¸” ë Œë”ë§
        renderTable();
    } catch (error) {
        console.error('Load status error:', error);
        alert('ìƒíƒœ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

function renderTable() {
    const tbody = document.getElementById('pcStatusTable');

    // í•„í„°ë§
    let filteredPCs = allPCs;
    if (currentFilter === 'online') {
        filteredPCs = allPCs.filter(pc => pc.is_online === 1);
    } else if (currentFilter === 'offline') {
        filteredPCs = allPCs.filter(pc => pc.is_online === 0);
    }

    if (filteredPCs.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; padding: 3em; color: #888;">
                    ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = filteredPCs.map(pc => {
        const minutes = Math.round(pc.minutes_since_last_seen * 10) / 10;
        const isOnline = pc.is_online === 1;

        // ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ë§Œ í‘œì‹œ
        let statusClass = isOnline ? 'status-online' : 'status-offline';
        let statusText = isOnline ? 'ì˜¨ë¼ì¸' : 'ì˜¤í”„ë¼ì¸';

        // ì´ˆ ë‹¨ìœ„ë¡œ í‘œì‹œ (1ë¶„ ë¯¸ë§Œì€ ì´ˆë¡œ)
        let timeDisplay;
        if (minutes < 1) {
            const seconds = Math.round(minutes * 60);
            timeDisplay = `${seconds}ì´ˆ ì „`;
        } else {
            timeDisplay = `${Math.round(minutes)}ë¶„ ì „`;
        }

        return `
            <tr class="pc-row">
                <td>
                    <span class="status-badge ${statusClass}">${statusText}</span>
                </td>
                <td style="font-weight: 600;">${pc.hostname || 'Unknown'}</td>
                <td style="font-family: monospace; font-size: 0.9em;">${pc.machine_id || 'N/A'}</td>
                <td>${formatDateTime(pc.last_seen)}</td>
                <td>
                    <span style="${minutes > 2 ? 'color: #ef4444; font-weight: 600;' : ''}">
                        ${timeDisplay}
                    </span>
                </td>
                <td style="color: #aaa; font-size: 0.9em;">${formatDateTime(pc.server_time)}</td>
            </tr>
        `;
    }).join('');
}

function formatDateTime(dateStr) {
    if (!dateStr) return 'N/A';
    const date = new Date(dateStr + ' UTC'); // SQLiteëŠ” UTC ì‹œê°„
    return date.toLocaleString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
}

function filterStatus(filter) {
    currentFilter = filter;

    // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById('filter' + filter.charAt(0).toUpperCase() + filter.slice(1)).classList.add('active');

    renderTable();
}

function refreshStatus() {
    loadStatus();
}

async function forceCheck() {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'â³ ì²´í¬ ì¤‘...';

    try {
        // API í˜¸ì¶œ ì‹œ ìë™ìœ¼ë¡œ update_offline_status() ì‹¤í–‰ë¨
        await loadStatus();

        // ì‹œê°ì  í”¼ë“œë°±
        btn.style.background = '#10b981';
        btn.textContent = 'âœ“ ì™„ë£Œ!';

        setTimeout(() => {
            btn.disabled = false;
            btn.style.background = '#f59e0b';
            btn.textContent = 'âš¡ ê°•ì œ ì²´í¬';
        }, 2000);

        console.log('ì˜¤í”„ë¼ì¸ ì²´í¬ ì™„ë£Œ');
    } catch (error) {
        btn.disabled = false;
        btn.textContent = 'âŒ ì‹¤íŒ¨';
        setTimeout(() => {
            btn.textContent = 'âš¡ ê°•ì œ ì²´í¬';
        }, 2000);
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
loadStatus();

// 30ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨ (í•˜íŠ¸ë¹„íŠ¸ ì£¼ê¸°ì™€ ë™ì¼)
setInterval(loadStatus, 30000);
</script>
{% endblock %}

