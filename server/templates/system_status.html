{% extends "base.html" %}
{% block title %}ì‹œìŠ¤í…œ ìƒíƒœ{% endblock %}
{% block content %}
<div class="page-container-lg">
    <div class="page-header">
        <h2>ğŸ” ì‹œìŠ¤í…œ ìƒíƒœ ëª¨ë‹ˆí„°ë§</h2>
        <div class="flex-gap">
            <button onclick="forceCheck()" class="btn btn-warning">âš¡ ê°•ì œ ì²´í¬</button>
            <button onclick="refreshStatus()" class="btn btn-success">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>
    </div>

    <!-- ìš”ì•½ í†µê³„ -->
    <div class="stat-grid">
        <div class="stat-card stat-card-online">
            <div class="stat-label">ì˜¨ë¼ì¸ PC</div>
            <div class="stat-value" id="onlineCount">0</div>
        </div>
        <div class="stat-card stat-card-offline">
            <div class="stat-label">ì˜¤í”„ë¼ì¸ PC</div>
            <div class="stat-value" id="offlineCount">0</div>
        </div>
        <div class="stat-card stat-card-total">
            <div class="stat-label">ì „ì²´ PC</div>
            <div class="stat-value" id="totalCount">0</div>
        </div>
        <div class="stat-card stat-card-update">
            <div class="stat-label">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</div>
            <div class="stat-value-sm" id="lastUpdate">-</div>
        </div>
    </div>

    <!-- í•„í„° -->
    <div class="filter-bar">
        <div class="flex-gap" style="align-items: center; flex-wrap: wrap;">
            <label>í•„í„°:</label>
            <button onclick="filterStatus('all')" id="filterAll" class="filter-btn active">ì „ì²´</button>
            <button onclick="filterStatus('online')" id="filterOnline" class="filter-btn">ì˜¨ë¼ì¸ë§Œ</button>
            <button onclick="filterStatus('offline')" id="filterOffline" class="filter-btn">ì˜¤í”„ë¼ì¸ë§Œ</button>
        </div>
    </div>

    <!-- PC ìƒíƒœ í…Œì´ë¸” -->
    <div class="data-table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>ìƒíƒœ</th>
                    <th>í˜¸ìŠ¤íŠ¸ëª…</th>
                    <th>Machine ID</th>
                    <th>ë§ˆì§€ë§‰ í•˜íŠ¸ë¹„íŠ¸</th>
                    <th>ê²½ê³¼ ì‹œê°„</th>
                    <th>ì„œë²„ ì‹œê°„</th>
                </tr>
            </thead>
            <tbody id="pcStatusTable">
                <!-- ë™ì  ìƒì„± -->
            </tbody>
        </table>
    </div>
</div>

<script>
let allPCs = [];
let currentFilter = 'all';

async function loadStatus() {
    try {
        const response = await fetch('/api/debug/pc-status');
        const data = await response.json();

        allPCs = data.pcs;

        document.getElementById('onlineCount').textContent = data.online_count;
        document.getElementById('offlineCount').textContent = data.offline_count;
        document.getElementById('totalCount').textContent = data.total;
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('ko-KR');

        renderTable();
    } catch (error) {
        console.error('Load status error:', error);
        alert('ìƒíƒœ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

function renderTable() {
    const tbody = document.getElementById('pcStatusTable');

    let filteredPCs = allPCs;
    if (currentFilter === 'online') {
        filteredPCs = allPCs.filter(pc => pc.is_online === 1);
    } else if (currentFilter === 'offline') {
        filteredPCs = allPCs.filter(pc => pc.is_online === 0);
    }

    if (filteredPCs.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center-msg" style="color: #888;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>`;
        return;
    }

    tbody.innerHTML = filteredPCs.map(pc => {
        const minutes = Math.round(pc.minutes_since_last_seen * 10) / 10;
        const isOnline = pc.is_online === 1;
        const statusClass = isOnline ? 'status-online' : 'status-offline';
        const statusText  = isOnline ? 'ì˜¨ë¼ì¸' : 'ì˜¤í”„ë¼ì¸';

        let timeDisplay;
        if (minutes < 1) {
            const seconds = Math.round(minutes * 60);
            timeDisplay = `${seconds}ì´ˆ ì „`;
        } else {
            timeDisplay = `${Math.round(minutes)}ë¶„ ì „`;
        }

        return `
            <tr class="pc-row">
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td class="fw-600">${pc.hostname || 'Unknown'}</td>
                <td class="text-mono">${pc.machine_id || 'N/A'}</td>
                <td>${formatDateTime(pc.last_seen)}</td>
                <td><span class="${minutes > 2 ? 'text-error-bold' : ''}">${timeDisplay}</span></td>
                <td class="text-muted-sm">${formatDateTime(pc.server_time)}</td>
            </tr>
        `;
    }).join('');
}

function formatDateTime(dateStr) {
    if (!dateStr) return 'N/A';
    const date = new Date(dateStr + ' UTC');
    return date.toLocaleString('ko-KR', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit'
    });
}

function filterStatus(filter) {
    currentFilter = filter;
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById('filter' + filter.charAt(0).toUpperCase() + filter.slice(1)).classList.add('active');
    renderTable();
}

function refreshStatus() { loadStatus(); }

async function forceCheck() {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'â³ ì²´í¬ ì¤‘...';
    try {
        await loadStatus();
        btn.style.background = '#10b981';
        btn.textContent = 'âœ“ ì™„ë£Œ!';
        setTimeout(() => {
            btn.disabled = false;
            btn.style.background = '';
            btn.textContent = 'âš¡ ê°•ì œ ì²´í¬';
        }, 2000);
    } catch (error) {
        btn.disabled = false;
        btn.textContent = 'âŒ ì‹¤íŒ¨';
        setTimeout(() => { btn.textContent = 'âš¡ ê°•ì œ ì²´í¬'; }, 2000);
    }
}

loadStatus();
setInterval(loadStatus, 30000);
</script>
{% endblock %}