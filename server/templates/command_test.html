{% extends "base.html" %}

{% block title %}ëª…ë ¹ í…ŒìŠ¤íŠ¸ - WCMS{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto; padding: 2em;">
    <h1 style="color: #4a9eff; margin-bottom: 1em;">ğŸ§ª ëª…ë ¹ ì‹¤í–‰ í…ŒìŠ¤íŠ¸</h1>

    <!-- PC ì„ íƒ -->
    <div style="background: #2a2a2a; padding: 1.5em; border-radius: 12px; margin-bottom: 2em;">
        <h2 style="color: #4a9eff; margin-bottom: 1em;">1. ëŒ€ìƒ PC ì„ íƒ</h2>
        <select id="pcSelect" style="width: 100%; padding: 0.8em; background: #1a1a1a; color: #e0e0e0; border: 1px solid #444; border-radius: 8px; font-size: 1em;">
            <option value="">PCë¥¼ ì„ íƒí•˜ì„¸ìš”...</option>
        </select>
        <div id="pcInfo" style="margin-top: 1em; color: #888; display: none;">
            <p><strong>í˜¸ìŠ¤íŠ¸ëª…:</strong> <span id="pcHostname"></span></p>
            <p><strong>ìƒíƒœ:</strong> <span id="pcStatus"></span></p>
            <p><strong>IP:</strong> <span id="pcIP"></span></p>
        </div>
    </div>

    <!-- ëª…ë ¹ ìœ í˜• ì„ íƒ -->
    <div style="background: #2a2a2a; padding: 1.5em; border-radius: 12px; margin-bottom: 2em;">
        <h2 style="color: #4a9eff; margin-bottom: 1em;">2. ëª…ë ¹ ìœ í˜• ì„ íƒ</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1em;">
            <button class="cmd-type-btn" data-type="execute">ğŸ’» CMD ì‹¤í–‰</button>
            <button class="cmd-type-btn" data-type="install">ğŸ“¦ winget ì„¤ì¹˜</button>
            <button class="cmd-type-btn" data-type="download">ğŸ“¥ íŒŒì¼ ë‹¤ìš´ë¡œë“œ</button>
        </div>
    </div>

    <!-- CMD ì‹¤í–‰ íŒ¨ë„ -->
    <div id="executePanel" class="cmd-panel" style="display: none;">
        <h3 style="color: #4a9eff; margin-bottom: 1em;">ğŸ’» CMD ëª…ë ¹ ì‹¤í–‰</h3>
        <div style="margin-bottom: 1em;">
            <label style="display: block; margin-bottom: 0.5em; color: #b0b0b0;">ëª…ë ¹ì–´:</label>
            <input type="text" id="cmdInput" placeholder="ì˜ˆ: dir, hostname, ipconfig" style="width: 100%; padding: 0.8em; background: #1a1a1a; color: #e0e0e0; border: 1px solid #444; border-radius: 8px;">
        </div>
        <div style="margin-bottom: 1em;">
            <p style="color: #888; font-size: 0.9em;">ë¹ ë¥¸ ëª…ë ¹:</p>
            <div style="display: flex; gap: 0.5em; flex-wrap: wrap;">
                <button class="quick-cmd" data-cmd="hostname">hostname</button>
                <button class="quick-cmd" data-cmd="whoami">whoami</button>
                <button class="quick-cmd" data-cmd="dir">dir</button>
                <button class="quick-cmd" data-cmd="ipconfig">ipconfig</button>
                <button class="quick-cmd" data-cmd="systeminfo | findstr /C:OS">OS ì •ë³´</button>
            </div>
        </div>
        <button onclick="sendCommand('execute')" class="send-btn">ğŸš€ ëª…ë ¹ ì „ì†¡</button>
    </div>

    <!-- winget ì„¤ì¹˜ íŒ¨ë„ -->
    <div id="installPanel" class="cmd-panel" style="display: none;">
        <h3 style="color: #4a9eff; margin-bottom: 1em;">ğŸ“¦ winget í”„ë¡œê·¸ë¨ ì„¤ì¹˜</h3>
        <div style="margin-bottom: 1em;">
            <label style="display: block; margin-bottom: 0.5em; color: #b0b0b0;">ì•± ID:</label>
            <input type="text" id="appIdInput" placeholder="ì˜ˆ: Notepad++.Notepad++" style="width: 100%; padding: 0.8em; background: #1a1a1a; color: #e0e0e0; border: 1px solid #444; border-radius: 8px;">
        </div>
        <div style="margin-bottom: 1em;">
            <p style="color: #888; font-size: 0.9em;">ì¸ê¸° í”„ë¡œê·¸ë¨:</p>
            <div style="display: flex; gap: 0.5em; flex-wrap: wrap;">
                <button class="quick-cmd" data-appid="Notepad++.Notepad++">Notepad++</button>
                <button class="quick-cmd" data-appid="7zip.7zip">7-Zip</button>
                <button class="quick-cmd" data-appid="VideoLAN.VLC">VLC</button>
                <button class="quick-cmd" data-appid="Google.Chrome">Chrome</button>
            </div>
        </div>
        <button onclick="sendCommand('install')" class="send-btn">ğŸ“¦ ì„¤ì¹˜ ì‹œì‘</button>
    </div>

    <!-- íŒŒì¼ ë‹¤ìš´ë¡œë“œ íŒ¨ë„ -->
    <div id="downloadPanel" class="cmd-panel" style="display: none;">
        <h3 style="color: #4a9eff; margin-bottom: 1em;">ğŸ“¥ íŒŒì¼ ë‹¤ìš´ë¡œë“œ</h3>
        <div style="margin-bottom: 1em;">
            <label style="display: block; margin-bottom: 0.5em; color: #b0b0b0;">URL:</label>
            <input type="text" id="urlInput" placeholder="https://example.com/file.zip" style="width: 100%; padding: 0.8em; background: #1a1a1a; color: #e0e0e0; border: 1px solid #444; border-radius: 8px;">
        </div>
        <div style="margin-bottom: 1em;">
            <label style="display: block; margin-bottom: 0.5em; color: #b0b0b0;">ì €ì¥ ê²½ë¡œ:</label>
            <input type="text" id="pathInput" placeholder="C:\\temp\\file.zip" value="C:\\temp\\download.txt" style="width: 100%; padding: 0.8em; background: #1a1a1a; color: #e0e0e0; border: 1px solid #444; border-radius: 8px;">
        </div>
        <div style="margin-bottom: 1em;">
            <p style="color: #888; font-size: 0.9em;">í…ŒìŠ¤íŠ¸ URL:</p>
            <div style="display: flex; gap: 0.5em; flex-wrap: wrap;">
                <button class="quick-cmd" data-url="https://www.google.com/robots.txt">robots.txt</button>
                <button class="quick-cmd" data-url="https://raw.githubusercontent.com/git/git/master/README.md">Git README</button>
            </div>
        </div>
        <button onclick="sendCommand('download')" class="send-btn">ğŸ“¥ ë‹¤ìš´ë¡œë“œ ì‹œì‘</button>
    </div>

    <!-- ê²°ê³¼ í‘œì‹œ -->
    <div id="resultPanel" style="background: #2a2a2a; padding: 1.5em; border-radius: 12px; margin-top: 2em; display: none;">
        <h3 style="color: #4a9eff; margin-bottom: 1em;">ğŸ“Š ì‹¤í–‰ ê²°ê³¼</h3>
        <div id="resultContent" style="background: #1a1a1a; padding: 1em; border-radius: 8px; color: #e0e0e0; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto;"></div>
    </div>
</div>

<style>
.cmd-type-btn {
    padding: 1.2em;
    background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
    color: #e0e0e0;
    border: 2px solid #444;
    border-radius: 12px;
    cursor: pointer;
    font-size: 1em;
    transition: all 0.3s ease;
}

.cmd-type-btn:hover {
    border-color: #4a9eff;
    background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
    transform: translateY(-2px);
}

.cmd-type-btn.active {
    border-color: #4a9eff;
    background: linear-gradient(135deg, #4a9eff 0%, #357abd 100%);
    color: white;
}

.cmd-panel {
    background: #2a2a2a;
    padding: 1.5em;
    border-radius: 12px;
    margin-bottom: 2em;
}

.quick-cmd {
    padding: 0.5em 1em;
    background: #1a1a1a;
    color: #4a9eff;
    border: 1px solid #4a9eff;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9em;
    transition: all 0.2s ease;
}

.quick-cmd:hover {
    background: #4a9eff;
    color: white;
}

.send-btn {
    width: 100%;
    padding: 1em;
    background: linear-gradient(135deg, #4a9eff 0%, #357abd 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1.1em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.send-btn:hover {
    background: linear-gradient(135deg, #357abd 0%, #2a5d8f 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(74, 158, 255, 0.3);
}

.send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
</style>

<script>
let selectedPC = null;
let currentCommandType = null;

// PC ëª©ë¡ ë¡œë“œ
async function loadPCs() {
    try {
        const response = await fetch('/api/pcs');
        const pcs = await response.json();

        const select = document.getElementById('pcSelect');
        select.innerHTML = '<option value="">PCë¥¼ ì„ íƒí•˜ì„¸ìš”...</option>';

        pcs.forEach(pc => {
            const option = document.createElement('option');
            option.value = pc.id;
            option.textContent = `${pc.hostname || 'Unknown'} (${pc.room_name || 'ë¯¸ë°°ì¹˜'}) - ${pc.is_online ? 'ğŸŸ¢ ì˜¨ë¼ì¸' : 'ğŸ”´ ì˜¤í”„ë¼ì¸'}`;
            option.dataset.pc = JSON.stringify(pc);
            select.appendChild(option);
        });
    } catch (error) {
        console.error('PC ëª©ë¡ ë¡œë”© ì˜¤ë¥˜:', error);
        alert('PC ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
}

// PC ì„ íƒ ì´ë²¤íŠ¸
document.getElementById('pcSelect').addEventListener('change', function() {
    const option = this.options[this.selectedIndex];
    if (option.value) {
        selectedPC = JSON.parse(option.dataset.pc);
        document.getElementById('pcInfo').style.display = 'block';
        document.getElementById('pcHostname').textContent = selectedPC.hostname;
        document.getElementById('pcStatus').textContent = selectedPC.is_online ? 'ğŸŸ¢ ì˜¨ë¼ì¸' : 'ğŸ”´ ì˜¤í”„ë¼ì¸';
        document.getElementById('pcIP').textContent = selectedPC.ip_address || 'N/A';
    } else {
        selectedPC = null;
        document.getElementById('pcInfo').style.display = 'none';
    }
});

// ëª…ë ¹ ìœ í˜• ì„ íƒ
document.querySelectorAll('.cmd-type-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const type = this.dataset.type;

        // í™œì„±í™” ìƒíƒœ í† ê¸€
        document.querySelectorAll('.cmd-type-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        // íŒ¨ë„ í‘œì‹œ
        document.querySelectorAll('.cmd-panel').forEach(p => p.style.display = 'none');
        document.getElementById(type + 'Panel').style.display = 'block';

        currentCommandType = type;
    });
});

// ë¹ ë¥¸ ëª…ë ¹ ë²„íŠ¼
document.querySelectorAll('.quick-cmd').forEach(btn => {
    btn.addEventListener('click', function() {
        if (this.dataset.cmd) {
            document.getElementById('cmdInput').value = this.dataset.cmd;
        } else if (this.dataset.appid) {
            document.getElementById('appIdInput').value = this.dataset.appid;
        } else if (this.dataset.url) {
            document.getElementById('urlInput').value = this.dataset.url;
        }
    });
});

// ëª…ë ¹ ì „ì†¡
async function sendCommand(type) {
    if (!selectedPC) {
        alert('PCë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
        return;
    }

    if (!selectedPC.is_online) {
        alert('ì˜¤í”„ë¼ì¸ ìƒíƒœì¸ PCì—ëŠ” ëª…ë ¹ì„ ì „ì†¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    let commandData = { type: type, data: {} };

    if (type === 'execute') {
        const cmd = document.getElementById('cmdInput').value.trim();
        if (!cmd) {
            alert('ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }
        commandData.data.command = cmd;
    } else if (type === 'install') {
        const appId = document.getElementById('appIdInput').value.trim();
        if (!appId) {
            alert('ì•± IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }
        commandData.data.app_name = appId;
    } else if (type === 'download') {
        const url = document.getElementById('urlInput').value.trim();
        const path = document.getElementById('pathInput').value.trim();
        if (!url || !path) {
            alert('URLê³¼ ì €ì¥ ê²½ë¡œë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }
        commandData.data.url = url;
        commandData.data.path = path;
    }

    try {
        const response = await fetch(`/api/pc/${selectedPC.id}/command`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(commandData)
        });

        const result = await response.json();

        if (result.status === 'success') {
            showResult(`âœ… ëª…ë ¹ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!\n\ní´ë¼ì´ì–¸íŠ¸ê°€ ëª…ë ¹ì„ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤...\n(ê²°ê³¼ëŠ” í´ë¼ì´ì–¸íŠ¸ ë¡œê·¸ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤)`);
        } else {
            showResult(`âŒ ëª…ë ¹ ì „ì†¡ ì‹¤íŒ¨\n\n${result.message}`);
        }
    } catch (error) {
        showResult(`âŒ ì˜¤ë¥˜ ë°œìƒ\n\n${error}`);
    }
}

function showResult(text) {
    document.getElementById('resultPanel').style.display = 'block';
    document.getElementById('resultContent').textContent = text;
    document.getElementById('resultPanel').scrollIntoView({ behavior: 'smooth' });
}

// ì´ˆê¸°í™”
loadPCs();
</script>
{% endblock %}

