{% extends "base.html" %}
{% block title %}Windows ê³„ì • ê´€ë¦¬{% endblock %}
{% block content %}
<style>
    .account-manager {
        max-width: 1200px;
    }
    
    .pc-selector {
        background: #2a2a2a;
        padding: 1.5em;
        border-radius: 10px;
        margin-bottom: 2em;
        border: 1px solid #333;
    }
    
    .pc-selector h3 {
        color: #4a9eff;
        margin-bottom: 1em;
    }
    
    .pc-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1em;
    }
    
    .pc-item {
        background: #1f1f1f;
        padding: 1em;
        border-radius: 8px;
        border: 2px solid #444;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
    }
    
    .pc-item:hover {
        border-color: #4a9eff;
        background: #252525;
        transform: translateY(-2px);
    }
    
    .pc-item.selected {
        border-color: #4a9eff;
        background: rgba(74, 158, 255, 0.15);
    }
    
    .pc-item.offline {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .pc-item .name {
        font-weight: 600;
        color: #e0e0e0;
        margin-bottom: 0.5em;
    }
    
    .pc-item .status {
        font-size: 0.85em;
        color: #888;
    }
    
    .pc-item.online .status { color: #4ade80; }
    .pc-item.offline .status { color: #666; }
    
    .account-panel {
        background: #2a2a2a;
        padding: 2em;
        border-radius: 10px;
        border: 1px solid #333;
        display: none;
    }
    
    .account-panel.active {
        display: block;
    }
    
    .account-panel h3 {
        color: #4a9eff;
        margin-bottom: 1.5em;
        padding-bottom: 0.5em;
        border-bottom: 1px solid #444;
    }
    
    .form-section {
        background: #1f1f1f;
        padding: 1.5em;
        border-radius: 8px;
        margin-bottom: 1.5em;
        border: 1px solid #333;
    }
    
    .form-section h4 {
        color: #fff;
        margin-bottom: 1em;
        font-size: 1.1em;
    }
    
    .form-group {
        margin-bottom: 1em;
    }
    
    .form-group label {
        display: block;
        color: #ccc;
        margin-bottom: 0.5em;
        font-weight: 500;
    }
    
    .form-group input, .form-group select {
        width: 100%;
        padding: 0.8em;
        background: #2a2a2a;
        border: 1px solid #444;
        border-radius: 6px;
        color: #e0e0e0;
        font-size: 1em;
    }
    
    .form-group input:focus, .form-group select:focus {
        outline: none;
        border-color: #4a9eff;
        box-shadow: 0 0 0 2px rgba(74, 158, 255, 0.2);
    }
    
    .form-group .help-text {
        font-size: 0.85em;
        color: #777;
        margin-top: 0.3em;
    }
    
    .btn-group {
        display: flex;
        gap: 0.8em;
    }
    
    .btn {
        padding: 0.8em 1.5em;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.95em;
        font-weight: 600;
        transition: all 0.3s;
    }
    
    .btn-primary {
        background: #4a9eff;
        color: white;
    }
    
    .btn-primary:hover {
        background: #3a8eef;
    }
    
    .btn-danger {
        background: #ef4444;
        color: white;
    }
    
    .btn-danger:hover {
        background: #dc2626;
    }
    
    .btn-warning {
        background: #f59e0b;
        color: white;
    }
    
    .btn-warning:hover {
        background: #d97706;
    }
    
    .alert {
        padding: 1em 1.5em;
        border-radius: 6px;
        margin-bottom: 1em;
        display: none;
    }
    
    .alert.show {
        display: block;
    }
    
    .alert-success {
        background: rgba(16, 185, 129, 0.15);
        border: 1px solid #10b981;
        color: #4ade80;
    }
    
    .alert-error {
        background: rgba(239, 68, 68, 0.15);
        border: 1px solid #ef4444;
        color: #f87171;
    }
    
    .alert-info {
        background: rgba(74, 158, 255, 0.15);
        border: 1px solid #4a9eff;
        color: #60a5fa;
    }
</style>

<div class="account-manager">
    <h2>Windows ê³„ì • ê´€ë¦¬</h2>
    
    <!-- PC ì„ íƒ -->
    <div class="pc-selector">
        <h3>ğŸ–¥ï¸ PC ì„ íƒ</h3>
        <div id="pcGrid" class="pc-grid">
            <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
        </div>
    </div>
    
    <!-- ê³„ì • ê´€ë¦¬ íŒ¨ë„ -->
    <div id="accountPanel" class="account-panel">
        <div id="alertContainer"></div>
        
        <h3 id="panelTitle">ê³„ì • ê´€ë¦¬</h3>
        
        <!-- ê³„ì • ìƒì„± -->
        <div class="form-section">
            <h4>â• ê³„ì • ìƒì„±</h4>
            <form id="createForm">
                <div class="form-group">
                    <label for="createUsername">ì‚¬ìš©ì ê³„ì •ëª… *</label>
                    <input type="text" id="createUsername" required 
                           pattern="[a-zA-Z0-9_]{3,20}" 
                           placeholder="ì˜ˆ: student01">
                    <div class="help-text">3-20ì, ì˜ìˆ«ìì™€ ì–¸ë”ìŠ¤ì½”ì–´ë§Œ ì‚¬ìš© ê°€ëŠ¥</div>
                </div>
                <div class="form-group">
                    <label for="createPassword">ë¹„ë°€ë²ˆí˜¸ *</label>
                    <input type="password" id="createPassword" required 
                           minlength="8"
                           placeholder="ìµœì†Œ 8ì ì´ìƒ">
                    <div class="help-text">ìµœì†Œ 8ì ì´ìƒ, ëŒ€ì†Œë¬¸ì+ìˆ«ì+íŠ¹ìˆ˜ë¬¸ì ê¶Œì¥</div>
                </div>
                <div class="form-group">
                    <label for="createFullName">ì „ì²´ ì´ë¦„</label>
                    <input type="text" id="createFullName" 
                           placeholder="ì˜ˆ: í™ê¸¸ë™">
                </div>
                <div class="form-group">
                    <label for="createComment">ê³„ì • ì„¤ëª…</label>
                    <input type="text" id="createComment" 
                           placeholder="ì˜ˆ: 2025í•™ë…„ë„ ì‹ ì…ìƒ">
                </div>
                <div class="form-group">
                    <label for="createLanguage">ì–¸ì–´ ì„¤ì •</label>
                    <select id="createLanguage">
                        <option value="">ê¸°ë³¸ê°’ (ë³€ê²½ ì•ˆí•¨)</option>
                        <option value="ko-KR">í•œêµ­ì–´ (ko-KR)</option>
                        <option value="en-US">ì˜ì–´ (en-US)</option>
                        <option value="zh-CN">ì¤‘êµ­ì–´ (zh-CN)</option>
                        <option value="mn-MN">ëª½ê³¨ì–´ (mn-MN)</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">ê³„ì • ìƒì„±</button>
                </div>
            </form>
        </div>
        
        <!-- ê³„ì • ì‚­ì œ -->
        <div class="form-section">
            <h4>ğŸ—‘ï¸ ê³„ì • ì‚­ì œ</h4>
            <form id="deleteForm">
                <div class="form-group">
                    <label for="deleteUsername">ì‚¬ìš©ì ê³„ì •ëª… *</label>
                    <input type="text" id="deleteUsername" required 
                           placeholder="ì‚­ì œí•  ê³„ì •ëª…">
                    <div class="help-text" style="color: #ef4444;">âš ï¸ ì‚­ì œëœ ê³„ì •ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-danger">ê³„ì • ì‚­ì œ</button>
                </div>
            </form>
        </div>
        
        <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ -->
        <div class="form-section">
            <h4>ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h4>
            <form id="passwordForm">
                <div class="form-group">
                    <label for="passwordUsername">ì‚¬ìš©ì ê³„ì •ëª… *</label>
                    <input type="text" id="passwordUsername" required 
                           placeholder="ê³„ì •ëª…">
                </div>
                <div class="form-group">
                    <label for="newPassword">ìƒˆ ë¹„ë°€ë²ˆí˜¸ *</label>
                    <input type="password" id="newPassword" required 
                           minlength="8"
                           placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸">
                    <div class="help-text">ìµœì†Œ 8ì ì´ìƒ</div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-warning">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let selectedPC = null;
let allPCs = [];

// í˜ì´ì§€ ë¡œë“œ ì‹œ PC ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
async function loadPCs() {
    try {
        const response = await fetch('/api/pcs');
        if (!response.ok) {
            throw new Error('PC ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        allPCs = await response.json();
        renderPCGrid();
    } catch (error) {
        console.error('PC ëª©ë¡ ë¡œë”© ì˜¤ë¥˜:', error);
        showAlert('PC ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
    }
}

// PC ê·¸ë¦¬ë“œ ë Œë”ë§
function renderPCGrid() {
    const grid = document.getElementById('pcGrid');
    
    if (allPCs.length === 0) {
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #888; padding: 2em;">ë“±ë¡ëœ PCê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
    }

    grid.innerHTML = allPCs.map(pc => `
        <div class="pc-item ${pc.is_online ? 'online' : 'offline'}" 
             data-pc-id="${pc.id}"
             onclick="${pc.is_online ? `selectPC(${pc.id})` : 'void(0)'}">
            <div class="name">${pc.hostname || 'Unknown'}</div>
            <div class="status">
                ${pc.is_online ? 'ğŸŸ¢ ì˜¨ë¼ì¸' : 'ğŸ”´ ì˜¤í”„ë¼ì¸'}
            </div>
            <div style="font-size: 0.8em; color: #666; margin-top: 0.5em;">
                ${pc.room_name || 'ë¯¸ë°°ì¹˜'}
            </div>
        </div>
    `).join('');
}

// PC ì„ íƒ
function selectPC(pcId) {
    selectedPC = allPCs.find(pc => pc.id === pcId);
    
    // ëª¨ë“  PC ì•„ì´í…œì—ì„œ selected í´ë˜ìŠ¤ ì œê±°
    document.querySelectorAll('.pc-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // ì„ íƒëœ PCì— selected í´ë˜ìŠ¤ ì¶”ê°€
    document.querySelector(`[data-pc-id="${pcId}"]`).classList.add('selected');
    
    // íŒ¨ë„ í‘œì‹œ
    const panel = document.getElementById('accountPanel');
    panel.classList.add('active');
    
    document.getElementById('panelTitle').textContent = 
        `${selectedPC.hostname} ê³„ì • ê´€ë¦¬`;
}

// ì•Œë¦¼ í‘œì‹œ
function showAlert(message, type = 'info') {
    const container = document.getElementById('alertContainer');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} show`;
    alert.textContent = message;
    
    container.innerHTML = '';
    container.appendChild(alert);
    
    // 5ì´ˆ í›„ ìë™ ìˆ¨ê¹€
    setTimeout(() => {
        alert.classList.remove('show');
        setTimeout(() => alert.remove(), 300);
    }, 5000);
}

// ê³„ì • ìƒì„±
document.getElementById('createForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!selectedPC) {
        showAlert('PCë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
        return;
    }
    
    const data = {
        username: document.getElementById('createUsername').value,
        password: document.getElementById('createPassword').value,
        full_name: document.getElementById('createFullName').value || null,
        comment: document.getElementById('createComment').value || null,
        language: document.getElementById('createLanguage').value || null
    };
    
    try {
        const response = await fetch(`/api/pc/${selectedPC.id}/account/create`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            showAlert(`ê³„ì • ìƒì„± ëª…ë ¹ì´ ${selectedPC.hostname}ì— ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
            e.target.reset();
        } else {
            showAlert(result.message || 'ê³„ì • ìƒì„± ì‹¤íŒ¨', 'error');
        }
    } catch (error) {
        showAlert('ì„œë²„ ì˜¤ë¥˜: ' + error.message, 'error');
    }
});

// ê³„ì • ì‚­ì œ
document.getElementById('deleteForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!selectedPC) {
        showAlert('PCë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
        return;
    }
    
    const username = document.getElementById('deleteUsername').value;
    
    if (!confirm(`ì •ë§ë¡œ '${username}' ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/pc/${selectedPC.id}/account/delete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            showAlert(`ê³„ì • ì‚­ì œ ëª…ë ¹ì´ ${selectedPC.hostname}ì— ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
            e.target.reset();
        } else {
            showAlert(result.message || 'ê³„ì • ì‚­ì œ ì‹¤íŒ¨', 'error');
        }
    } catch (error) {
        showAlert('ì„œë²„ ì˜¤ë¥˜: ' + error.message, 'error');
    }
});

// ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
document.getElementById('passwordForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!selectedPC) {
        showAlert('PCë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
        return;
    }
    
    const data = {
        username: document.getElementById('passwordUsername').value,
        new_password: document.getElementById('newPassword').value
    };
    
    try {
        const response = await fetch(`/api/pc/${selectedPC.id}/account/password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            showAlert(`ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª…ë ¹ì´ ${selectedPC.hostname}ì— ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
            e.target.reset();
        } else {
            showAlert(result.message || 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨', 'error');
        }
    } catch (error) {
        showAlert('ì„œë²„ ì˜¤ë¥˜: ' + error.message, 'error');
    }
});

// ì´ˆê¸°í™”
loadPCs();
</script>
{% endblock %}