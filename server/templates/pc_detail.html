{% extends "base.html" %}

{% block title %}{{ pc.hostname or 'PC ìƒì„¸ ì •ë³´' }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>{{ pc.hostname or 'PC-' + pc.id|string }} ìƒì„¸ ì •ë³´</h2>

    {% if pc %}
    <div class="card mt-3">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">ê¸°ë³¸ ì •ë³´</h5>
        </div>
        <div class="card-body">
            <table class="table table-bordered">
                <tr>
                    <th width="30%">í˜¸ìŠ¤íŠ¸ëª…</th>
                    <td>{{ pc.hostname or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>ì‹¤ìŠµì‹¤</th>
                    <td>{{ pc.room_name or 'ë¯¸ë°°ì¹˜' }}</td>
                </tr>
                <tr>
                    <th>ì¢Œì„ ë²ˆí˜¸</th>
                    <td>{{ pc.seat_number or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>IP ì£¼ì†Œ</th>
                    <td>{{ pc.ip_address or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>MAC ì£¼ì†Œ</th>
                    <td>{{ pc.mac_address or pc.machine_id or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>ì˜¨ë¼ì¸ ìƒíƒœ</th>
                    <td>
                        {% if pc.is_online %}
                        <span class="badge bg-success">ì˜¨ë¼ì¸</span>
                        {% else %}
                        <span class="badge bg-secondary">ì˜¤í”„ë¼ì¸</span>
                        {% endif %}
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <div class="card mt-3">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">ì‹œìŠ¤í…œ ì •ë³´</h5>
        </div>
        <div class="card-body">
            <table class="table table-bordered">
                <tr>
                    <th width="30%">CPU ëª¨ë¸</th>
                    <td>{{ pc.cpu_model or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>CPU ì‚¬ìš©ë¥ </th>
                    <td>
                        {% if pc.cpu_usage is not none %}
                        {{ pc.cpu_usage }}%
                        {% else %}
                        N/A
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>RAM ì „ì²´</th>
                    <td>
                        {% if pc.ram_total %}
                        {{ pc.ram_total }} GB
                        {% else %}
                        N/A
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>RAM ì‚¬ìš©</th>
                    <td>
                        {% if pc.ram_used %}
                        {{ pc.ram_used }} GB ({{ pc.ram_usage_percent|round(1) if pc.ram_usage_percent else 'N/A' }}%)
                        {% else %}
                        N/A
                        {% endif %}
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <!-- ë””ìŠ¤í¬ ì •ë³´ ì‹œê°í™” -->
    <div class="card mt-3">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">ğŸ’¾ ë””ìŠ¤í¬ ì‚¬ìš© í˜„í™©</h5>
        </div>
        <div class="card-body">
            {% if pc.disk_info_parsed %}
            <div class="row">
                {% for dev, info in pc.disk_info_parsed.items() %}
                <div class="col-md-6 mb-4">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="text-center mb-3">
                                <strong>{{ dev }}</strong>
                                <small class="text-muted">({{ info.fstype or 'Unknown' }})</small>
                            </h6>

                            <!-- ë””ìŠ¤í¬ ì •ë³´ í‘œì‹œ -->
                            <div style="text-align: center; margin-bottom: 15px;">
                                {% if info.used_gb is defined and info.free_gb is defined and info.total_gb is defined %}
                                    {% set total_gb = info.total_gb %}
                                    {% set used_gb = info.used_gb %}
                                    {% set free_gb = info.free_gb %}
                                    {% set usage_percent = ((used_gb / total_gb) * 100)|round(1) if total_gb > 0 else 0 %}
                                {% elif info.percent is defined and info.total_gb is defined %}
                                    {% set total_gb = info.total_gb %}
                                    {% set usage_percent = info.percent %}
                                    {% set used_gb = ((total_gb * usage_percent) / 100)|round(2) %}
                                    {% set free_gb = (total_gb - used_gb)|round(2) %}
                                {% else %}
                                    {% set total_gb = info.total_gb or 0 %}
                                    {% set used_gb = 0 %}
                                    {% set free_gb = total_gb %}
                                    {% set usage_percent = 0 %}
                                {% endif %}

                                <p class="mb-2">
                                    <strong style="font-size: 1.5em; color: #dc3545;">{{ usage_percent }}%</strong>
                                    <small class="text-muted">ì‚¬ìš© ì¤‘</small>
                                </p>

                                <!-- ì§„í–‰ ë°” -->
                                <div class="progress" style="height: 25px;">
                                    {% if usage_percent > 90 %}
                                        <div class="progress-bar bg-danger" role="progressbar"
                                             style="width: {{ usage_percent }}%;"
                                             aria-valuenow="{{ usage_percent }}" aria-valuemin="0" aria-valuemax="100">
                                            {{ used_gb|round(1) }} GB
                                        </div>
                                    {% elif usage_percent > 75 %}
                                        <div class="progress-bar bg-warning" role="progressbar"
                                             style="width: {{ usage_percent }}%;"
                                             aria-valuenow="{{ usage_percent }}" aria-valuemin="0" aria-valuemax="100">
                                            {{ used_gb|round(1) }} GB
                                        </div>
                                    {% else %}
                                        <div class="progress-bar bg-success" role="progressbar"
                                             style="width: {{ usage_percent }}%;"
                                             aria-valuenow="{{ usage_percent }}" aria-valuemin="0" aria-valuemax="100">
                                            {{ used_gb|round(1) }} GB
                                        </div>
                                    {% endif %}
                                </div>

                                <p class="mt-2 mb-0">
                                    <small class="text-muted">
                                        ì—¬ìœ : {{ free_gb|round(1) }} GB / ì´: {{ total_gb|round(1) }} GB
                                    </small>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted">ë””ìŠ¤í¬ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}
        </div>
    </div>

    <div class="card mt-3">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">ê¸°íƒ€ ì •ë³´</h5>
        </div>
        <div class="card-body">
            <table class="table table-bordered">
                <tr>
                    <th>OS ë²„ì „</th>
                    <td>{{ pc.os_edition }} <small class="text-muted">({{ pc.os_version or 'ë²„ì „ ì •ë³´ ì—†ìŒ' }})</small></td>
                </tr>
                <tr>
                    <th>í˜„ì¬ ì‚¬ìš©ì</th>
                    <td>{{ pc.current_user or 'N/A' }}</td>
                </tr>
            </table>
        </div>
    </div>

    <div class="mt-3">
        <button class="btn btn-secondary" onclick="history.back()">ëŒì•„ê°€ê¸°</button>
        <a href="{{ url_for('pc_history_page', pc_id=pc.id) }}" class="btn btn-info">í”„ë¡œì„¸ìŠ¤ ê¸°ë¡ ë³´ê¸°</a>

        {% if admin %}
        <button class="btn btn-danger" onclick="sendCommand('shutdown')">ì¢…ë£Œ</button>
        <button class="btn btn-warning" onclick="sendCommand('restart')">ì¬ì‹œì‘</button>
        <button class="btn btn-danger" onclick="deletePC({{ pc.id }}, '{{ pc.hostname }}')">ğŸ—‘ï¸ PC ì‚­ì œ</button>
        {% endif %}
    </div>

    {% else %}
    <div class="alert alert-danger mt-3">
        ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
    </div>
    {% endif %}
</div>

<script>
function sendCommand(type) {
    if (!confirm(`ì •ë§ë¡œ ${type === 'shutdown' ? 'ì¢…ë£Œ' : 'ì¬ì‹œì‘'}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    fetch('/api/{{ pc.id }}/command', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({type: type, data: {}})
    })
    .then(r => r.json())
    .then(data => {
        alert(data.message || 'ëª…ë ¹ ì „ì†¡ ì™„ë£Œ');
    })
    .catch(err => {
        alert('ì˜¤ë¥˜ ë°œìƒ: ' + err);
    });
}

function deletePC(pcId, hostname) {
    if (!confirm(`ì •ë§ë¡œ ${hostname} (ID: ${pcId})ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nì´ PCì˜ ëª¨ë“  ë°ì´í„°(ëª…ë ¹, ìƒíƒœ ì •ë³´ ë“±)ê°€ ì‚­ì œë©ë‹ˆë‹¤.`)) {
        return;
    }

    // ë‘ ë²ˆ í™•ì¸
    if (!confirm(`ë§ˆì§€ë§‰ í™•ì¸: ${hostname}ì„(ë¥¼) ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }

    fetch(`/api/pc/${pcId}`, {
        method: 'DELETE'
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            alert(`âœ… ${hostname}ì´(ê°€) ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            window.location.href = '/';
        } else {
            alert(`âŒ ì‚­ì œ ì‹¤íŒ¨: ${data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
        }
    })
    .catch(err => {
        alert('ì˜¤ë¥˜ ë°œìƒ: ' + err);
    });
}
</script>
{% endblock %}
