{% extends "base.html" %}

{% block title %}{{ pc.hostname or 'PC ÏÉÅÏÑ∏ Ï†ïÎ≥¥' }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>{{ pc.hostname or 'PC-' + pc.id|string }} ÏÉÅÏÑ∏ Ï†ïÎ≥¥</h2>

    {% if pc %}
    <div class="card mt-3">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Í∏∞Î≥∏ Ï†ïÎ≥¥</h5>
        </div>
        <div class="card-body">
            <table class="table table-bordered">
                <tr>
                    <th width="30%">Ìò∏Ïä§Ìä∏Î™Ö</th>
                    <td>{{ pc.hostname or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>Ïã§ÏäµÏã§</th>
                    <td>{{ pc.room_name or 'ÎØ∏Î∞∞Ïπò' }}</td>
                </tr>
                <tr>
                    <th>Ï¢åÏÑù Î≤àÌò∏</th>
                    <td>{{ pc.seat_number or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>IP Ï£ºÏÜå</th>
                    <td>{{ pc.ip_address or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>MAC Ï£ºÏÜå</th>
                    <td>{{ pc.mac_address or pc.machine_id or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>Ïò®ÎùºÏù∏ ÏÉÅÌÉú</th>
                    <td>
                        {% if pc.is_online %}
                        <span class="badge bg-success">Ïò®ÎùºÏù∏</span>
                        {% else %}
                        <span class="badge bg-secondary">Ïò§ÌîÑÎùºÏù∏</span>
                        {% endif %}
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <div class="card mt-3">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">ÏãúÏä§ÌÖú Ï†ïÎ≥¥</h5>
        </div>
        <div class="card-body">
            <table class="table table-bordered">
                <tr>
                    <th width="30%">CPU Î™®Îç∏</th>
                    <td>{{ pc.cpu_model or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>CPU ÏÇ¨Ïö©Î•†</th>
                    <td>
                        {% if pc.cpu_usage is not none %}
                        {{ pc.cpu_usage }}%
                        {% else %}
                        N/A
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>RAM Ï†ÑÏ≤¥</th>
                    <td>
                        {% if pc.ram_total %}
                        {{ pc.ram_total }} GB
                        {% else %}
                        N/A
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>RAM ÏÇ¨Ïö©</th>
                    <td>
                        {% if pc.ram_used %}
                        {{ pc.ram_used }} GB ({{ pc.ram_usage_percent|round(1) if pc.ram_usage_percent else 'N/A' }}%)
                        {% else %}
                        N/A
                        {% endif %}
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <!-- ÎîîÏä§ÌÅ¨ Ï†ïÎ≥¥ ÏãúÍ∞ÅÌôî -->
    <div class="card mt-3">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">üíæ ÎîîÏä§ÌÅ¨ ÏÇ¨Ïö© ÌòÑÌô©</h5>
        </div>
        <div class="card-body">
            {% if pc.disk_info_parsed %}
            <div class="row">
                {% for dev, info in pc.disk_info_parsed.items() %}
                <div class="col-md-6 mb-4">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="text-center mb-3">
                                <strong>{{ dev }}</strong>
                                <small class="text-muted">({{ info.fstype or 'Unknown' }})</small>
                            </h6>

                            <!-- ÎîîÏä§ÌÅ¨ Ï†ïÎ≥¥ ÌëúÏãú -->
                            <div style="text-align: center; margin-bottom: 15px;">
                                {% if info.used_gb is defined and info.free_gb is defined and info.total_gb is defined %}
                                    {% set total_gb = info.total_gb %}
                                    {% set used_gb = info.used_gb %}
                                    {% set free_gb = info.free_gb %}
                                    {% set usage_percent = ((used_gb / total_gb) * 100)|round(1) if total_gb > 0 else 0 %}
                                {% elif info.percent is defined and info.total_gb is defined %}
                                    {% set total_gb = info.total_gb %}
                                    {% set usage_percent = info.percent %}
                                    {% set used_gb = ((total_gb * usage_percent) / 100)|round(2) %}
                                    {% set free_gb = (total_gb - used_gb)|round(2) %}
                                {% else %}
                                    {% set total_gb = info.total_gb or 0 %}
                                    {% set used_gb = 0 %}
                                    {% set free_gb = total_gb %}
                                    {% set usage_percent = 0 %}
                                {% endif %}

                                <!-- ÎèÑÎÑõ Ï∞®Ìä∏ -->
                                <div style="max-width: 200px; margin: 0 auto 20px;">
                                    <canvas id="diskChart_{{ dev|replace('\\', '_')|replace(':', '') }}"></canvas>
                                </div>

                                <p class="mb-2">
                                    <strong style="font-size: 1.5em; color: #dc3545;">{{ usage_percent }}%</strong>
                                    <small class="text-muted">ÏÇ¨Ïö© Ï§ë</small>
                                </p>

                                <!-- ÏßÑÌñâ Î∞î -->
                                <div class="progress" style="height: 25px;">
                                    {% if usage_percent > 90 %}
                                        <div class="progress-bar bg-danger" role="progressbar"
                                             style="width: {{ usage_percent }}%;"
                                             aria-valuenow="{{ usage_percent }}" aria-valuemin="0" aria-valuemax="100">
                                            {{ used_gb|round(1) }} GB
                                        </div>
                                    {% elif usage_percent > 75 %}
                                        <div class="progress-bar bg-warning" role="progressbar"
                                             style="width: {{ usage_percent }}%;"
                                             aria-valuenow="{{ usage_percent }}" aria-valuemin="0" aria-valuemax="100">
                                            {{ used_gb|round(1) }} GB
                                        </div>
                                    {% else %}
                                        <div class="progress-bar bg-success" role="progressbar"
                                             style="width: {{ usage_percent }}%;"
                                             aria-valuenow="{{ usage_percent }}" aria-valuemin="0" aria-valuemax="100">
                                            {{ used_gb|round(1) }} GB
                                        </div>
                                    {% endif %}
                                </div>

                                <p class="mt-2 mb-0">
                                    <small class="text-muted">
                                        Ïó¨Ïú†: {{ free_gb|round(1) }} GB / Ï¥ù: {{ total_gb|round(1) }} GB
                                    </small>
                                </p>

                                <script>
                                // ÎèÑÎÑõ Ï∞®Ìä∏ ÏÉùÏÑ±
                                (function() {
                                    const ctx = document.getElementById('diskChart_{{ dev|replace('\\', '_')|replace(':', '') }}');
                                    if (ctx) {
                                        new Chart(ctx, {
                                            type: 'doughnut',
                                            data: {
                                                labels: ['ÏÇ¨Ïö© Ï§ë', 'Ïó¨Ïú†'],
                                                datasets: [{
                                                    data: [{{ used_gb|round(2) }}, {{ free_gb|round(2) }}],
                                                    backgroundColor: [
                                                        {% if usage_percent > 90 %}
                                                        'rgba(220, 38, 38, 0.8)',
                                                        {% elif usage_percent > 75 %}
                                                        'rgba(245, 158, 11, 0.8)',
                                                        {% else %}
                                                        'rgba(16, 185, 129, 0.8)',
                                                        {% endif %}
                                                        'rgba(107, 114, 128, 0.3)'
                                                    ],
                                                    borderColor: [
                                                        {% if usage_percent > 90 %}
                                                        'rgba(220, 38, 38, 1)',
                                                        {% elif usage_percent > 75 %}
                                                        'rgba(245, 158, 11, 1)',
                                                        {% else %}
                                                        'rgba(16, 185, 129, 1)',
                                                        {% endif %}
                                                        'rgba(107, 114, 128, 0.5)'
                                                    ],
                                                    borderWidth: 2
                                                }]
                                            },
                                            options: {
                                                responsive: true,
                                                maintainAspectRatio: true,
                                                plugins: {
                                                    legend: {
                                                        position: 'bottom',
                                                        labels: {
                                                            color: '#666',
                                                            font: {
                                                                size: 11
                                                            }
                                                        }
                                                    },
                                                    tooltip: {
                                                        callbacks: {
                                                            label: function(context) {
                                                                const label = context.label || '';
                                                                const value = context.parsed || 0;
                                                                return label + ': ' + value.toFixed(1) + ' GB';
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        });
                                    }
                                })();
                                </script>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted">ÎîîÏä§ÌÅ¨ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
            {% endif %}
        </div>
    </div>

    <div class="card mt-3">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">Í∏∞ÌÉÄ Ï†ïÎ≥¥</h5>
        </div>
        <div class="card-body">
            <table class="table table-bordered">
                <tr>
                    <th>OS Î≤ÑÏ†Ñ</th>
                    <td>{{ pc.os_edition }} <small class="text-muted">({{ pc.os_version or 'Î≤ÑÏ†Ñ Ï†ïÎ≥¥ ÏóÜÏùå' }})</small></td>
                </tr>
                <tr>
                    <th>ÌòÑÏû¨ ÏÇ¨Ïö©Ïûê</th>
                    <td>{{ pc.current_user or 'N/A' }}</td>
                </tr>
            </table>
        </div>
    </div>

    <div class="mt-3">
        <button class="btn btn-secondary" onclick="history.back()">ÎèåÏïÑÍ∞ÄÍ∏∞</button>
        <a href="{{ url_for('pc_history_page', pc_id=pc.id) }}" class="btn btn-info">ÌîÑÎ°úÏÑ∏Ïä§ Í∏∞Î°ù Î≥¥Í∏∞</a>

        {% if admin %}
        <button class="btn btn-danger" onclick="sendCommand('shutdown')">Ï¢ÖÎ£å</button>
        <button class="btn btn-warning" onclick="sendCommand('restart')">Ïû¨ÏãúÏûë</button>
        <button class="btn btn-danger" onclick="deletePC({{ pc.id }}, '{{ pc.hostname }}')">üóëÔ∏è PC ÏÇ≠Ï†ú</button>
        {% endif %}
    </div>

    {% else %}
    <div class="alert alert-danger mt-3">
        Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.
    </div>
    {% endif %}
</div>

<script>
function sendCommand(type) {
    if (!confirm(`Ï†ïÎßêÎ°ú ${type === 'shutdown' ? 'Ï¢ÖÎ£å' : 'Ïû¨ÏãúÏûë'}ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;

    fetch('/api/{{ pc.id }}/command', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({type: type, data: {}})
    })
    .then(r => r.json())
    .then(data => {
        alert(data.message || 'Î™ÖÎ†π Ï†ÑÏÜ° ÏôÑÎ£å');
    })
    .catch(err => {
        alert('Ïò§Î•ò Î∞úÏÉù: ' + err);
    });
}

function deletePC(pcId, hostname) {
    if (!confirm(`Ï†ïÎßêÎ°ú ${hostname} (ID: ${pcId})Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÏù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.\n\nÏù¥ PCÏùò Î™®Îì† Îç∞Ïù¥ÌÑ∞(Î™ÖÎ†π, ÏÉÅÌÉú Ï†ïÎ≥¥ Îì±)Í∞Ä ÏÇ≠Ï†úÎê©ÎãàÎã§.`)) {
        return;
    }

    // Îëê Î≤à ÌôïÏù∏
    if (!confirm(`ÎßàÏßÄÎßâ ÌôïÏù∏: ${hostname}ÏùÑ(Î•º) Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
        return;
    }

    fetch(`/api/pc/${pcId}`, {
        method: 'DELETE'
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            alert(`‚úÖ ${hostname}Ïù¥(Í∞Ä) ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`);
            window.location.href = '/';
        } else {
            alert(`‚ùå ÏÇ≠Ï†ú Ïã§Ìå®: ${data.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'}`);
        }
    })
    .catch(err => {
        alert('Ïò§Î•ò Î∞úÏÉù: ' + err);
    });
}
</script>
{% endblock %}
