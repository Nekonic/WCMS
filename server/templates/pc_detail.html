{% extends "base.html" %}

{% block title %}{{ pc.hostname or 'PC ìƒì„¸ ì •ë³´' }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>{{ pc.hostname or 'PC-' + pc.id|string }} ìƒì„¸ ì •ë³´</h2>

    {% if pc %}
    <div class="card mt-3">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">ê¸°ë³¸ ì •ë³´</h5>
        </div>
        <div class="card-body">
            <table class="table table-bordered">
                <tr>
                    <th width="30%">í˜¸ìŠ¤íŠ¸ëª…</th>
                    <td>{{ pc.hostname or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>ì‹¤ìŠµì‹¤</th>
                    <td>{{ pc.room_name or 'ë¯¸ë°°ì¹˜' }}</td>
                </tr>
                <tr>
                    <th>ì¢Œì„ ë²ˆí˜¸</th>
                    <td>{{ pc.seat_number or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>IP ì£¼ì†Œ</th>
                    <td>{{ pc.ip_address or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>MAC ì£¼ì†Œ</th>
                    <td>{{ pc.mac_address or pc.machine_id or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>ì˜¨ë¼ì¸ ìƒíƒœ</th>
                    <td>
                        {% if pc.is_online %}
                        <span class="badge bg-success">ì˜¨ë¼ì¸</span>
                        {% else %}
                        <span class="badge bg-secondary">ì˜¤í”„ë¼ì¸</span>
                        {% endif %}
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <div class="card mt-3">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">ì‹œìŠ¤í…œ ì •ë³´</h5>
        </div>
        <div class="card-body">
            <table class="table table-bordered">
                <tr>
                    <th width="30%">CPU ëª¨ë¸</th>
                    <td>{{ pc.cpu_model or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>CPU ì‚¬ìš©ë¥ </th>
                    <td>
                        {% if pc.cpu_usage is not none %}
                        {{ pc.cpu_usage }}%
                        {% else %}
                        N/A
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>RAM ì „ì²´</th>
                    <td>
                        {% if pc.ram_total %}
                        {{ pc.ram_total }} GB
                        {% else %}
                        N/A
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>RAM ì‚¬ìš©</th>
                    <td>
                        {% if pc.ram_used %}
                        {{ pc.ram_used }} GB ({{ pc.ram_usage_percent|round(1) if pc.ram_usage_percent else 'N/A' }}%)
                        {% else %}
                        N/A
                        {% endif %}
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <!-- ë””ìŠ¤í¬ ì •ë³´ ì‹œê°í™” -->
    <div class="card mt-3">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">ğŸ’¾ ë””ìŠ¤í¬ ì‚¬ìš© í˜„í™©</h5>
        </div>
        <div class="card-body">
            {% if pc.disk_info_parsed %}
            <div class="row">
                {% for dev, info in pc.disk_info_parsed.items() %}
                <div class="col-md-6 mb-4">
                    <div class="card bg-dark">
                        <div class="card-body">
                            <h6 class="text-center mb-3">
                                <strong>{{ dev }}</strong>
                                <small class="text-muted">({{ info.fstype or 'Unknown' }})</small>
                            </h6>

                            <!-- ë„ë„› ì°¨íŠ¸ -->
                            <div style="position: relative; height: 200px; margin-bottom: 20px;">
                                <canvas id="diskChart{{ loop.index }}"></canvas>
                            </div>

                            <!-- ìƒì„¸ ì •ë³´ -->
                            <div class="text-center">
                                {% if info.used_gb is defined and info.free_gb is defined %}
                                <p class="mb-1">
                                    <span class="badge bg-danger">ì‚¬ìš©: {{ info.used_gb }} GB</span>
                                    <span class="badge bg-success">ì—¬ìœ : {{ info.free_gb }} GB</span>
                                </p>
                                <p class="mb-0">
                                    <small class="text-muted">ì´ ìš©ëŸ‰: {{ info.total_gb }} GB</small>
                                </p>
                                {% elif info.total_gb is defined %}
                                <p class="mb-0">
                                    <span class="badge bg-info">ì´ ìš©ëŸ‰: {{ info.total_gb }} GB</span>
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted">ë””ìŠ¤í¬ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}
        </div>
    </div>

    <div class="card mt-3">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">ê¸°íƒ€ ì •ë³´</h5>
        </div>
        <div class="card-body">
            <table class="table table-bordered">
                <tr>
                    <th>OS ë²„ì „</th>
                    <td>{{ pc.os_edition }} <small class="text-muted">({{ pc.os_version or 'ë²„ì „ ì •ë³´ ì—†ìŒ' }})</small></td>
                </tr>
                <tr>
                    <th>í˜„ì¬ ì‚¬ìš©ì</th>
                    <td>{{ pc.current_user or 'N/A' }}</td>
                </tr>
            </table>
        </div>
    </div>

    <div class="mt-3">
        <button class="btn btn-secondary" onclick="history.back()">ëŒì•„ê°€ê¸°</button>
        <a href="{{ url_for('pc_history_page', pc_id=pc.id) }}" class="btn btn-info">í”„ë¡œì„¸ìŠ¤ ê¸°ë¡ ë³´ê¸°</a>

        {% if admin %}
        <button class="btn btn-danger" onclick="sendCommand('shutdown')">ì¢…ë£Œ</button>
        <button class="btn btn-warning" onclick="sendCommand('restart')">ì¬ì‹œì‘</button>
        {% endif %}
    </div>

    {% else %}
    <div class="alert alert-danger mt-3">
        ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
    </div>
    {% endif %}
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// ë””ìŠ¤í¬ ì°¨íŠ¸ ìƒì„±
{% if pc.disk_info_parsed %}
const diskData = {{ pc.disk_info_parsed|tojson }};
let chartIndex = 1;

for (const [dev, info] of Object.entries(diskData)) {
    const ctx = document.getElementById(`diskChart${chartIndex}`);
    if (!ctx) continue;

    let usedGB = 0;
    let freeGB = 0;
    let usagePercent = 0;

    // ë™ì  ì •ë³´ì—ì„œ ì‚¬ìš©ëŸ‰ ê°€ì ¸ì˜¤ê¸°
    if (info.used_gb !== undefined && info.free_gb !== undefined) {
        usedGB = parseFloat(info.used_gb);
        freeGB = parseFloat(info.free_gb);
        const totalGB = usedGB + freeGB;
        usagePercent = totalGB > 0 ? ((usedGB / totalGB) * 100).toFixed(1) : 0;
    } else if (info.percent !== undefined) {
        // percentë§Œ ìˆëŠ” ê²½ìš°
        usagePercent = parseFloat(info.percent).toFixed(1);
        const totalGB = parseFloat(info.total_gb) || 100;
        usedGB = (totalGB * usagePercent / 100).toFixed(2);
        freeGB = (totalGB - usedGB).toFixed(2);
    } else if (info.total_gb) {
        // ì´ ìš©ëŸ‰ë§Œ ìˆëŠ” ê²½ìš° (ì‚¬ìš©ëŸ‰ ì •ë³´ ì—†ìŒ)
        usedGB = 0;
        freeGB = parseFloat(info.total_gb);
        usagePercent = 0;
    }

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['ì‚¬ìš© ì¤‘', 'ì—¬ìœ  ê³µê°„'],
            datasets: [{
                data: [usedGB, freeGB],
                backgroundColor: [
                    'rgba(220, 53, 69, 0.8)',   // ë¹¨ê°• (ì‚¬ìš©)
                    'rgba(25, 135, 84, 0.8)'    // ì´ˆë¡ (ì—¬ìœ )
                ],
                borderColor: [
                    'rgba(220, 53, 69, 1)',
                    'rgba(25, 135, 84, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed.toFixed(2) + ' GB';
                        }
                    }
                },
                // ì¤‘ì•™ì— ì‚¬ìš©ë¥  í‘œì‹œ
                beforeDraw: function(chart) {
                    const ctx = chart.ctx;
                    ctx.restore();
                    const fontSize = (chart.height / 114).toFixed(2);
                    ctx.font = fontSize + "em sans-serif";
                    ctx.textBaseline = "middle";
                    ctx.fillStyle = "#fff";

                    const text = usagePercent + "%";
                    const textX = Math.round((chart.width - ctx.measureText(text).width) / 2);
                    const textY = chart.height / 2;

                    ctx.fillText(text, textX, textY);
                    ctx.save();
                }
            }
        },
        plugins: [{
            beforeDraw: function(chart) {
                const ctx = chart.ctx;
                const width = chart.width;
                const height = chart.height;

                ctx.restore();
                ctx.font = "bold 24px sans-serif";
                ctx.textBaseline = "middle";
                ctx.fillStyle = "#e0e0e0";

                const text = usagePercent + "%";
                const textX = Math.round((width - ctx.measureText(text).width) / 2);
                const textY = height / 2;

                ctx.fillText(text, textX, textY);
                ctx.save();
            }
        }]
    });

    chartIndex++;
}
{% endif %}

function sendCommand(type) {
    if (!confirm(`ì •ë§ë¡œ ${type === 'shutdown' ? 'ì¢…ë£Œ' : 'ì¬ì‹œì‘'}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    fetch('/api/{{ pc.id }}/command', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({type: type, data: {}})
    })
    .then(r => r.json())
    .then(data => {
        alert(data.message || 'ëª…ë ¹ ì „ì†¡ ì™„ë£Œ');
    })
    .catch(err => {
        alert('ì˜¤ë¥˜ ë°œìƒ: ' + err);
    });
}
</script>
{% endblock %}
