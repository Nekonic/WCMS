{% extends "base.html" %}
{% block title %}ì‹¤ìŠµì‹¤ ê´€ë¦¬{% endblock %}
{% block content %}
<div class="page-container-md">
    <div class="page-header">
        <h2>ğŸ« ì‹¤ìŠµì‹¤ ê´€ë¦¬</h2>
        <button onclick="showCreateRoomModal()" class="btn btn-success">â• ì‹¤ìŠµì‹¤ ì¶”ê°€</button>
    </div>

    <!-- ì‹¤ìŠµì‹¤ ëª©ë¡ -->
    <div id="roomsList" style="display: grid; gap: 1.5em;">
        <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
    </div>
</div>

<!-- ì‹¤ìŠµì‹¤ ìƒì„± ëª¨ë‹¬ -->
<div id="createRoomModal" class="modal-overlay">
    <div class="modal-dialog">
        <div class="modal-dialog-header">
            <h3>ìƒˆ ì‹¤ìŠµì‹¤ ìƒì„±</h3>
            <button onclick="closeCreateRoomModal()" class="btn-close-red">ë‹«ê¸°</button>
        </div>
        <form id="createRoomForm" onsubmit="createRoom(event)">
            <div class="form-group">
                <label class="form-label">ì‹¤ìŠµì‹¤ ì´ë¦„ *</label>
                <input type="text" id="newRoomName" required placeholder="ì˜ˆ: 5ì‹¤ìŠµì‹¤, Aë™ ì‹¤ìŠµì‹¤" class="form-input">
            </div>
            <div class="form-grid-2 form-group">
                <div>
                    <label class="form-label">í–‰ (ì„¸ë¡œ)</label>
                    <input type="number" id="newRoomRows" value="6" min="1" max="20" class="form-input">
                </div>
                <div>
                    <label class="form-label">ì—´ (ê°€ë¡œ)</label>
                    <input type="number" id="newRoomCols" value="8" min="1" max="20" class="form-input">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">ì„¤ëª… (ì„ íƒ)</label>
                <textarea id="newRoomDesc" rows="3" placeholder="ì˜ˆ: 3ì¸µ ë™ìª½ ì‹¤ìŠµì‹¤" class="form-input" style="resize: vertical;"></textarea>
            </div>
            <button type="submit" class="btn btn-success" style="width: 100%;">ìƒì„±</button>
        </form>
    </div>
</div>

<!-- ì‹¤ìŠµì‹¤ ìˆ˜ì • ëª¨ë‹¬ -->
<div id="editRoomModal" class="modal-overlay">
    <div class="modal-dialog">
        <div class="modal-dialog-header">
            <h3>ì‹¤ìŠµì‹¤ ìˆ˜ì •</h3>
            <button onclick="closeEditRoomModal()" class="btn-close-red">ë‹«ê¸°</button>
        </div>
        <form id="editRoomForm" onsubmit="updateRoom(event)">
            <input type="hidden" id="editRoomId">
            <div class="form-group">
                <label class="form-label">ì‹¤ìŠµì‹¤ ì´ë¦„ *</label>
                <input type="text" id="editRoomName" required class="form-input">
            </div>
            <div class="form-grid-2 form-group">
                <div>
                    <label class="form-label">í–‰ (ì„¸ë¡œ)</label>
                    <input type="number" id="editRoomRows" min="1" max="20" class="form-input">
                </div>
                <div>
                    <label class="form-label">ì—´ (ê°€ë¡œ)</label>
                    <input type="number" id="editRoomCols" min="1" max="20" class="form-input">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">ì„¤ëª…</label>
                <textarea id="editRoomDesc" rows="3" class="form-input" style="resize: vertical;"></textarea>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5em; cursor: pointer;">
                    <input type="checkbox" id="editRoomActive" style="width: 20px; height: 20px;">
                    <span class="form-label" style="margin-bottom: 0;">í™œì„±í™” (ì‚¬ì´ë“œë°”ì— í‘œì‹œ)</span>
                </label>
            </div>
            <button type="submit" class="btn btn-info" style="width: 100%;">ìˆ˜ì •</button>
        </form>
    </div>
</div>

<script>
let allRooms = [];

async function loadRooms() {
    try {
        const response = await fetch('/api/rooms');
        const data = await response.json();
        allRooms = data.rooms;
        renderRooms();
    } catch (error) {
        console.error('Load rooms error:', error);
        alert('ì‹¤ìŠµì‹¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

function renderRooms() {
    const container = document.getElementById('roomsList');

    if (allRooms.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <p style="font-size: 1.2em; margin-bottom: 0.5em;">ë“±ë¡ëœ ì‹¤ìŠµì‹¤ì´ ì—†ìŠµë‹ˆë‹¤</p>
                <p>ì˜¤ë¥¸ìª½ ìƒë‹¨ì˜ "â• ì‹¤ìŠµì‹¤ ì¶”ê°€" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>
            </div>
        `;
        return;
    }

    container.innerHTML = allRooms.map(room => `
        <div class="room-card ${room.is_active ? '' : 'inactive'}">
            <div class="room-card-header">
                <div>
                    <h3 style="margin: 0 0 0.5em 0; color: white; font-size: 1.3em;">
                        ${room.room_name}
                        <span class="badge ${room.is_active ? 'badge-active' : 'badge-inactive'}">
                            ${room.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}
                        </span>
                    </h3>
                    ${room.description ? `<p class="text-muted">${room.description}</p>` : ''}
                </div>
            </div>

            <div class="room-info-grid">
                <div class="room-info-cell room-info-cell-blue">
                    <div class="info-label">ë°°ì¹˜ í¬ê¸°</div>
                    <div class="info-value">${room.rows}í–‰ Ã— ${room.cols}ì—´</div>
                </div>
                <div class="room-info-cell room-info-cell-green">
                    <div class="info-label">ë“±ë¡ëœ PC</div>
                    <div class="info-value">${room.pc_count}ëŒ€</div>
                </div>
                <div class="room-info-cell room-info-cell-purple">
                    <div class="info-label">ìƒì„±ì¼</div>
                    <div class="info-value info-value-sm">${formatDate(room.created_at)}</div>
                </div>
            </div>

            <div class="room-actions">
                <button class="btn-edit" onclick="showEditRoomModal(${room.id})">âœï¸ ìˆ˜ì •</button>
                <button class="btn-delete" onclick="deleteRoom(${room.id}, '${room.room_name}', ${room.pc_count})">ğŸ—‘ï¸ ì‚­ì œ</button>
            </div>
        </div>
    `).join('');
}

function formatDate(dateStr) {
    return new Date(dateStr).toLocaleDateString('ko-KR');
}

function showCreateRoomModal() {
    document.getElementById('createRoomModal').classList.add('show');
    document.getElementById('createRoomForm').reset();
}
function closeCreateRoomModal() { document.getElementById('createRoomModal').classList.remove('show'); }

async function createRoom(event) {
    event.preventDefault();
    const roomName = document.getElementById('newRoomName').value.trim();
    const rows = parseInt(document.getElementById('newRoomRows').value);
    const cols = parseInt(document.getElementById('newRoomCols').value);
    const description = document.getElementById('newRoomDesc').value.trim();
    try {
        const response = await fetch('/api/rooms', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ room_name: roomName, rows, cols, description })
        });
        const data = await response.json();
        if (response.ok) { alert(`âœ… ${roomName}ì´(ê°€) ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`); closeCreateRoomModal(); loadRooms(); location.reload(); }
        else { alert(`âŒ ${data.message || 'ìƒì„± ì‹¤íŒ¨'}`); }
    } catch (error) { console.error('Create room error:', error); alert('ì‹¤ìŠµì‹¤ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
}

function showEditRoomModal(roomId) {
    const room = allRooms.find(r => r.id === roomId);
    if (!room) return;
    document.getElementById('editRoomId').value = room.id;
    document.getElementById('editRoomName').value = room.room_name;
    document.getElementById('editRoomRows').value = room.rows;
    document.getElementById('editRoomCols').value = room.cols;
    document.getElementById('editRoomDesc').value = room.description || '';
    document.getElementById('editRoomActive').checked = room.is_active === 1;
    document.getElementById('editRoomModal').classList.add('show');
}
function closeEditRoomModal() { document.getElementById('editRoomModal').classList.remove('show'); }

async function updateRoom(event) {
    event.preventDefault();
    const roomId = document.getElementById('editRoomId').value;
    const roomName = document.getElementById('editRoomName').value.trim();
    const rows = parseInt(document.getElementById('editRoomRows').value);
    const cols = parseInt(document.getElementById('editRoomCols').value);
    const description = document.getElementById('editRoomDesc').value.trim();
    const isActive = document.getElementById('editRoomActive').checked ? 1 : 0;
    try {
        const response = await fetch(`/api/rooms/${roomId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ room_name: roomName, rows, cols, description, is_active: isActive })
        });
        const data = await response.json();
        if (response.ok) { alert(`âœ… ${roomName}ì´(ê°€) ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`); closeEditRoomModal(); loadRooms(); location.reload(); }
        else { alert(`âŒ ${data.message || 'ìˆ˜ì • ì‹¤íŒ¨'}`); }
    } catch (error) { console.error('Update room error:', error); alert('ì‹¤ìŠµì‹¤ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
}

async function deleteRoom(roomId, roomName, pcCount) {
    if (pcCount > 0) { alert(`âŒ ì´ ì‹¤ìŠµì‹¤ì—ëŠ” ${pcCount}ëŒ€ì˜ PCê°€ ë°°ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\në¨¼ì € ë°°ì¹˜ í¸ì§‘ì—ì„œ PCë¥¼ ì œê±°í•˜ì„¸ìš”.`); return; }
    if (!confirm(`ì •ë§ë¡œ "${roomName}"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;
    try {
        const response = await fetch(`/api/rooms/${roomId}`, { method: 'DELETE' });
        const data = await response.json();
        if (response.ok) { alert(`âœ… ${roomName}ì´(ê°€) ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`); loadRooms(); location.reload(); }
        else { alert(`âŒ ${data.message || 'ì‚­ì œ ì‹¤íŒ¨'}`); }
    } catch (error) { console.error('Delete room error:', error); alert('ì‹¤ìŠµì‹¤ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
}

loadRooms();
</script>
{% endblock %}