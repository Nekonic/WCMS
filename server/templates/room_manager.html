{% extends "base.html" %}
{% block title %}ì‹¤ìŠµì‹¤ ê´€ë¦¬{% endblock %}
{% block content %}
<div style="max-width: 1200px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2em;">
        <h2 style="margin: 0;">ğŸ« ì‹¤ìŠµì‹¤ ê´€ë¦¬</h2>
        <button onclick="showCreateRoomModal()" style="
            background: #10b981;
            color: white;
            padding: 0.7em 1.5em;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        " onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
            â• ì‹¤ìŠµì‹¤ ì¶”ê°€
        </button>
    </div>

    <!-- ì‹¤ìŠµì‹¤ ëª©ë¡ -->
    <div id="roomsList" style="display: grid; gap: 1.5em;">
        <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
    </div>
</div>

<!-- ì‹¤ìŠµì‹¤ ìƒì„± ëª¨ë‹¬ -->
<div id="createRoomModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 2000; padding: 2em;">
    <div style="max-width: 600px; margin: 4em auto; background: #2a2a2a; border-radius: 12px; padding: 2em;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5em;">
            <h3 style="margin: 0; color: white;">ìƒˆ ì‹¤ìŠµì‹¤ ìƒì„±</h3>
            <button onclick="closeCreateRoomModal()" style="background: #dc2626; color: white; border: none; padding: 0.5em 1em; border-radius: 6px; cursor: pointer;">ë‹«ê¸°</button>
        </div>

        <form id="createRoomForm" onsubmit="createRoom(event)">
            <div style="margin-bottom: 1.5em;">
                <label style="display: block; margin-bottom: 0.5em; color: #aaa;">ì‹¤ìŠµì‹¤ ì´ë¦„ *</label>
                <input type="text" id="newRoomName" required placeholder="ì˜ˆ: 5ì‹¤ìŠµì‹¤, Aë™ ì‹¤ìŠµì‹¤" style="
                    width: 100%;
                    padding: 0.8em;
                    background: #1a1a1a;
                    border: 1px solid #444;
                    border-radius: 6px;
                    color: white;
                    font-size: 1em;
                ">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em; margin-bottom: 1.5em;">
                <div>
                    <label style="display: block; margin-bottom: 0.5em; color: #aaa;">í–‰ (ì„¸ë¡œ)</label>
                    <input type="number" id="newRoomRows" value="6" min="1" max="20" style="
                        width: 100%;
                        padding: 0.8em;
                        background: #1a1a1a;
                        border: 1px solid #444;
                        border-radius: 6px;
                        color: white;
                    ">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5em; color: #aaa;">ì—´ (ê°€ë¡œ)</label>
                    <input type="number" id="newRoomCols" value="8" min="1" max="20" style="
                        width: 100%;
                        padding: 0.8em;
                        background: #1a1a1a;
                        border: 1px solid #444;
                        border-radius: 6px;
                        color: white;
                    ">
                </div>
            </div>

            <div style="margin-bottom: 1.5em;">
                <label style="display: block; margin-bottom: 0.5em; color: #aaa;">ì„¤ëª… (ì„ íƒ)</label>
                <textarea id="newRoomDesc" rows="3" placeholder="ì˜ˆ: 3ì¸µ ë™ìª½ ì‹¤ìŠµì‹¤" style="
                    width: 100%;
                    padding: 0.8em;
                    background: #1a1a1a;
                    border: 1px solid #444;
                    border-radius: 6px;
                    color: white;
                    font-size: 1em;
                    resize: vertical;
                "></textarea>
            </div>

            <button type="submit" style="
                width: 100%;
                background: #10b981;
                color: white;
                padding: 0.9em;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 600;
                font-size: 1em;
            ">ìƒì„±</button>
        </form>
    </div>
</div>

<!-- ì‹¤ìŠµì‹¤ ìˆ˜ì • ëª¨ë‹¬ -->
<div id="editRoomModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 2000; padding: 2em;">
    <div style="max-width: 600px; margin: 4em auto; background: #2a2a2a; border-radius: 12px; padding: 2em;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5em;">
            <h3 style="margin: 0; color: white;">ì‹¤ìŠµì‹¤ ìˆ˜ì •</h3>
            <button onclick="closeEditRoomModal()" style="background: #dc2626; color: white; border: none; padding: 0.5em 1em; border-radius: 6px; cursor: pointer;">ë‹«ê¸°</button>
        </div>

        <form id="editRoomForm" onsubmit="updateRoom(event)">
            <input type="hidden" id="editRoomId">

            <div style="margin-bottom: 1.5em;">
                <label style="display: block; margin-bottom: 0.5em; color: #aaa;">ì‹¤ìŠµì‹¤ ì´ë¦„ *</label>
                <input type="text" id="editRoomName" required style="
                    width: 100%;
                    padding: 0.8em;
                    background: #1a1a1a;
                    border: 1px solid #444;
                    border-radius: 6px;
                    color: white;
                    font-size: 1em;
                ">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em; margin-bottom: 1.5em;">
                <div>
                    <label style="display: block; margin-bottom: 0.5em; color: #aaa;">í–‰ (ì„¸ë¡œ)</label>
                    <input type="number" id="editRoomRows" min="1" max="20" style="
                        width: 100%;
                        padding: 0.8em;
                        background: #1a1a1a;
                        border: 1px solid #444;
                        border-radius: 6px;
                        color: white;
                    ">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5em; color: #aaa;">ì—´ (ê°€ë¡œ)</label>
                    <input type="number" id="editRoomCols" min="1" max="20" style="
                        width: 100%;
                        padding: 0.8em;
                        background: #1a1a1a;
                        border: 1px solid #444;
                        border-radius: 6px;
                        color: white;
                    ">
                </div>
            </div>

            <div style="margin-bottom: 1.5em;">
                <label style="display: block; margin-bottom: 0.5em; color: #aaa;">ì„¤ëª…</label>
                <textarea id="editRoomDesc" rows="3" style="
                    width: 100%;
                    padding: 0.8em;
                    background: #1a1a1a;
                    border: 1px solid #444;
                    border-radius: 6px;
                    color: white;
                    font-size: 1em;
                    resize: vertical;
                "></textarea>
            </div>

            <div style="margin-bottom: 1.5em;">
                <label style="display: flex; align-items: center; gap: 0.5em; cursor: pointer;">
                    <input type="checkbox" id="editRoomActive" style="width: 20px; height: 20px;">
                    <span style="color: #aaa;">í™œì„±í™” (ì‚¬ì´ë“œë°”ì— í‘œì‹œ)</span>
                </label>
            </div>

            <button type="submit" style="
                width: 100%;
                background: #3b82f6;
                color: white;
                padding: 0.9em;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 600;
                font-size: 1em;
            ">ìˆ˜ì •</button>
        </form>
    </div>
</div>

<style>
.room-card {
    background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
    border-radius: 10px;
    border: 1px solid #333;
    padding: 1.5em;
    transition: all 0.3s;
}

.room-card:hover {
    border-color: #4a9eff;
    box-shadow: 0 4px 12px rgba(74, 158, 255, 0.2);
}

.room-card.inactive {
    opacity: 0.6;
    border-color: #555;
}

.room-actions {
    display: flex;
    gap: 0.5em;
    margin-top: 1em;
}

.room-actions button {
    flex: 1;
    padding: 0.6em;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
}

.btn-edit {
    background: #3b82f6;
    color: white;
}

.btn-edit:hover {
    background: #2563eb;
}

.btn-delete {
    background: #dc2626;
    color: white;
}

.btn-delete:hover {
    background: #b91c1c;
}

.badge {
    display: inline-block;
    padding: 0.3em 0.8em;
    border-radius: 12px;
    font-size: 0.85em;
    font-weight: 600;
}

.badge-active {
    background: #10b981;
    color: white;
}

.badge-inactive {
    background: #6b7280;
    color: white;
}
</style>

<script>
let allRooms = [];

// ì‹¤ìŠµì‹¤ ëª©ë¡ ë¡œë“œ
async function loadRooms() {
    try {
        const response = await fetch('/api/rooms');
        const data = await response.json();

        allRooms = data.rooms;
        renderRooms();
    } catch (error) {
        console.error('Load rooms error:', error);
        alert('ì‹¤ìŠµì‹¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ì‹¤ìŠµì‹¤ ëª©ë¡ ë Œë”ë§
function renderRooms() {
    const container = document.getElementById('roomsList');

    if (allRooms.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 3em; color: #888;">
                <p style="font-size: 1.2em; margin-bottom: 0.5em;">ë“±ë¡ëœ ì‹¤ìŠµì‹¤ì´ ì—†ìŠµë‹ˆë‹¤</p>
                <p>ì˜¤ë¥¸ìª½ ìƒë‹¨ì˜ "â• ì‹¤ìŠµì‹¤ ì¶”ê°€" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>
            </div>
        `;
        return;
    }

    container.innerHTML = allRooms.map(room => `
        <div class="room-card ${room.is_active ? '' : 'inactive'}">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1em;">
                <div>
                    <h3 style="margin: 0 0 0.5em 0; color: white; font-size: 1.3em;">
                        ${room.room_name}
                        <span class="badge ${room.is_active ? 'badge-active' : 'badge-inactive'}">
                            ${room.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}
                        </span>
                    </h3>
                    ${room.description ? `<p style="color: #aaa; margin: 0;">${room.description}</p>` : ''}
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1em; margin-bottom: 1em;">
                <div style="background: rgba(74, 158, 255, 0.1); padding: 0.8em; border-radius: 6px;">
                    <div style="color: #aaa; font-size: 0.85em; margin-bottom: 0.3em;">ë°°ì¹˜ í¬ê¸°</div>
                    <div style="color: white; font-weight: 600;">${room.rows}í–‰ Ã— ${room.cols}ì—´</div>
                </div>
                <div style="background: rgba(16, 185, 129, 0.1); padding: 0.8em; border-radius: 6px;">
                    <div style="color: #aaa; font-size: 0.85em; margin-bottom: 0.3em;">ë“±ë¡ëœ PC</div>
                    <div style="color: white; font-weight: 600;">${room.pc_count}ëŒ€</div>
                </div>
                <div style="background: rgba(139, 92, 246, 0.1); padding: 0.8em; border-radius: 6px;">
                    <div style="color: #aaa; font-size: 0.85em; margin-bottom: 0.3em;">ìƒì„±ì¼</div>
                    <div style="color: white; font-weight: 600; font-size: 0.9em;">${formatDate(room.created_at)}</div>
                </div>
            </div>

            <div class="room-actions">
                <button class="btn-edit" onclick="showEditRoomModal(${room.id})">
                    âœï¸ ìˆ˜ì •
                </button>
                <button class="btn-delete" onclick="deleteRoom(${room.id}, '${room.room_name}', ${room.pc_count})">
                    ğŸ—‘ï¸ ì‚­ì œ
                </button>
            </div>
        </div>
    `).join('');
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('ko-KR');
}

// ìƒì„± ëª¨ë‹¬
function showCreateRoomModal() {
    document.getElementById('createRoomModal').style.display = 'block';
    document.getElementById('createRoomForm').reset();
}

function closeCreateRoomModal() {
    document.getElementById('createRoomModal').style.display = 'none';
}

async function createRoom(event) {
    event.preventDefault();

    const roomName = document.getElementById('newRoomName').value.trim();
    const rows = parseInt(document.getElementById('newRoomRows').value);
    const cols = parseInt(document.getElementById('newRoomCols').value);
    const description = document.getElementById('newRoomDesc').value.trim();

    try {
        const response = await fetch('/api/rooms', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                room_name: roomName,
                rows: rows,
                cols: cols,
                description: description
            })
        });

        const data = await response.json();

        if (response.ok) {
            alert(`âœ… ${roomName}ì´(ê°€) ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            closeCreateRoomModal();
            loadRooms();
            location.reload(); // ì‚¬ì´ë“œë°” ìƒˆë¡œê³ ì¹¨
        } else {
            alert(`âŒ ${data.message || 'ìƒì„± ì‹¤íŒ¨'}`);
        }
    } catch (error) {
        console.error('Create room error:', error);
        alert('ì‹¤ìŠµì‹¤ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ìˆ˜ì • ëª¨ë‹¬
function showEditRoomModal(roomId) {
    const room = allRooms.find(r => r.id === roomId);
    if (!room) return;

    document.getElementById('editRoomId').value = room.id;
    document.getElementById('editRoomName').value = room.room_name;
    document.getElementById('editRoomRows').value = room.rows;
    document.getElementById('editRoomCols').value = room.cols;
    document.getElementById('editRoomDesc').value = room.description || '';
    document.getElementById('editRoomActive').checked = room.is_active === 1;

    document.getElementById('editRoomModal').style.display = 'block';
}

function closeEditRoomModal() {
    document.getElementById('editRoomModal').style.display = 'none';
}

async function updateRoom(event) {
    event.preventDefault();

    const roomId = document.getElementById('editRoomId').value;
    const roomName = document.getElementById('editRoomName').value.trim();
    const rows = parseInt(document.getElementById('editRoomRows').value);
    const cols = parseInt(document.getElementById('editRoomCols').value);
    const description = document.getElementById('editRoomDesc').value.trim();
    const isActive = document.getElementById('editRoomActive').checked ? 1 : 0;

    try {
        const response = await fetch(`/api/rooms/${roomId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                room_name: roomName,
                rows: rows,
                cols: cols,
                description: description,
                is_active: isActive
            })
        });

        const data = await response.json();

        if (response.ok) {
            alert(`âœ… ${roomName}ì´(ê°€) ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            closeEditRoomModal();
            loadRooms();
            location.reload(); // ì‚¬ì´ë“œë°” ìƒˆë¡œê³ ì¹¨
        } else {
            alert(`âŒ ${data.message || 'ìˆ˜ì • ì‹¤íŒ¨'}`);
        }
    } catch (error) {
        console.error('Update room error:', error);
        alert('ì‹¤ìŠµì‹¤ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ì‚­ì œ
async function deleteRoom(roomId, roomName, pcCount) {
    if (pcCount > 0) {
        alert(`âŒ ì´ ì‹¤ìŠµì‹¤ì—ëŠ” ${pcCount}ëŒ€ì˜ PCê°€ ë°°ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\në¨¼ì € ë°°ì¹˜ í¸ì§‘ì—ì„œ PCë¥¼ ì œê±°í•˜ì„¸ìš”.`);
        return;
    }

    if (!confirm(`ì •ë§ë¡œ "${roomName}"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
        return;
    }

    try {
        const response = await fetch(`/api/rooms/${roomId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (response.ok) {
            alert(`âœ… ${roomName}ì´(ê°€) ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            loadRooms();
            location.reload(); // ì‚¬ì´ë“œë°” ìƒˆë¡œê³ ì¹¨
        } else {
            alert(`âŒ ${data.message || 'ì‚­ì œ ì‹¤íŒ¨'}`);
        }
    } catch (error) {
        console.error('Delete room error:', error);
        alert('ì‹¤ìŠµì‹¤ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤ìŠµì‹¤ ëª©ë¡ ë¡œë“œ
loadRooms();
</script>
{% endblock %}

